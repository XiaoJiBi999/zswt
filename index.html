<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植树问题练习工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                        neutral: '#6B7280'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0;
            }
            .page-transition {
                @apply transition-all duration-300 ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-tree text-green-600 text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-dark">植树问题练习工具</h1>
            </div>
            <button id="fullscreenBtn" class="p-2 rounded-full hover:bg-light transition-colors">
                <i class="fa fa-expand text-neutral"></i>
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 角色选择界面 -->
        <div id="roleSelection" class="max-w-2xl mx-auto text-center py-10">
            <h2 class="text-2xl md:text-3xl font-bold mb-8 text-dark">请选择角色</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button id="studentBtn" class="p-8 bg-white text-dark border-2 border-primary rounded-xl btn-hover flex flex-col items-center justify-center">
                    <i class="fa fa-user-circle text-5xl text-primary mb-4"></i>
                    <span class="text-xl font-semibold">学生</span>
                    <p class="text-sm text-neutral mt-2">进行植树问题练习</p>
                </button>
                <button id="teacherBtn" class="p-8 bg-white text-dark border-2 border-primary rounded-xl btn-hover flex flex-col items-center justify-center">
                    <i class="fa fa-graduation-cap text-5xl text-primary mb-4"></i>
                    <span class="text-xl font-semibold">教师</span>
                    <p class="text-sm text-neutral mt-2">查看统计分析数据</p>
                </button>
            </div>
        </div>

        <!-- 学生界面 -->
        <div id="studentInterface" class="hidden max-w-4xl mx-auto">
            <!-- 学生首页 -->
            <div id="studentHome" class="text-center py-10 page-transition">
                <h2 class="text-2xl md:text-3xl font-bold mb-8 text-dark">植树问题练习</h2>
                <p class="text-neutral mb-8 max-w-lg mx-auto">
                    请填写你的信息，然后开始练习。完成后可以获得详细的解题反馈和分析。
                </p>
                
                <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-sm">
                    <div class="mb-6">
                        <label class="block text-neutral mb-2 text-left">姓名：</label>
                        <input type="text" id="studentName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="例如：张三">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-neutral mb-2 text-left">班级：</label>
                        <select id="studentClass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <option value="" selected disabled>请选择班级</option>
                            <option value="五年1班">五年1班</option>
                            <option value="五年2班">五年2班</option>
                            <option value="五年3班">五年3班</option>
                            <option value="五年4班">五年4班</option>
                        </select>
                    </div>
                </div>
                
                <button id="startBtn" class="px-8 py-4 bg-secondary text-white rounded-lg btn-hover text-lg mt-8">
                    开始答题 <i class="fa fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- 题目页面（初始隐藏） -->
            <div id="questionPages" class="hidden page-transition">
                <!-- 题目导航 -->
                <div class="flex justify-center mb-8 flex-wrap gap-3">
                    <button class="question-nav-btn px-5 py-3 border-2 rounded-lg text-dark" data-question="1">第1题</button>
                    <button class="question-nav-btn px-5 py-3 border-2 rounded-lg text-dark" data-question="2">第2题</button>
                    <button class="question-nav-btn px-5 py-3 border-2 rounded-lg text-dark" data-question="3">第3题</button>
                    <button class="question-nav-btn px-5 py-3 border-2 rounded-lg text-dark" data-question="4">第4题</button>
                </div>

                <!-- 题目内容区域 -->
                <div id="questionContent">
                    <!-- 题目将通过JS动态生成 -->
                </div>

                <!-- 通用题目表单（由JS动态生成） -->
                <template id="questionFormTemplate">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-neutral mb-2 text-lg">道路长度：（ ）米</label>
                            <input type="number" class="road-length-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" min="1">
                        </div>
                        <div>
                            <label class="block text-neutral mb-2 text-lg">两棵树之间的间隔距离：（ ）米</label>
                            <input type="number" class="interval-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-neutral mb-3 text-lg">选择植树类型：</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                                <input type="radio" name="plantType" value="bothEnds" class="mr-3 text-primary">
                                <span>两端都栽</span>
                            </label>
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                                <input type="radio" name="plantType" value="oneEnd" class="mr-3 text-primary">
                                <span>一端栽，一端不栽</span>
                            </label>
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                                <input type="radio" name="plantType" value="noEnd" class="mr-3 text-primary">
                                <span>两端都不栽</span>
                            </label>
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                                <input type="radio" name="plantType" value="circle" class="mr-3 text-primary">
                                <span>封闭环形（如池塘周围）</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-neutral mb-2 text-lg">计算过程及结果：（请写出计算过程和答案）</label>
                        <textarea class="calculation-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" rows="3" placeholder="例如：20÷4=5（段），5+1=6（棵）"></textarea>
                    </div>
                    
                    <!-- 示意图绘制区域 -->
                    <div class="mb-6">
                        <label class="block text-neutral mb-3 text-lg">示意图：</label>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <canvas class="plant-canvas w-full h-48 md:h-64 border border-gray-100 rounded"></canvas>
                            <button class="draw-btn mt-3 px-4 py-2 bg-primary/10 text-primary rounded-lg btn-hover">
                                <i class="fa fa-paint-brush mr-2"></i>绘制示意图
                            </button>
                        </div>
                    </div>
                </template>

                <!-- 结果反馈区域（初始隐藏） -->
                <div id="resultFeedback" class="mt-10 p-6 rounded-xl border border-green-200 bg-green-50 hidden page-transition">
                    <h3 id="feedbackTitle" class="text-2xl font-bold mb-6 text-center text-green-600">恭喜你！所有题目都答对了！</h3>
                    <div id="feedbackContent" class="mb-8">
                        <!-- 反馈内容将通过JS动态生成 -->
                    </div>
                    
                    <!-- 针对性练习区域 -->
                    <div id="errorExercises" class="mb-8 hidden">
                        <h4 class="text-xl font-semibold mb-4 text-dark">针对性练习：</h4>
                        <div class="exercises-list space-y-4">
                            <!-- 练习内容将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="restartBtn" class="px-8 py-4 bg-secondary text-white rounded-lg btn-hover text-lg">
                            <i class="fa fa-refresh mr-2"></i> 重新练习
                        </button>
                        <button id="studentExitBtn" class="ml-4 px-8 py-4 bg-neutral text-white rounded-lg btn-hover text-lg">
                            <i class="fa fa-sign-out mr-2"></i> 退出
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教师界面 -->
        <div id="teacherInterface" class="hidden max-w-5xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-2xl md:text-3xl font-bold mb-2 text-dark">教师分析面板</h2>
                <p class="text-neutral">查看班级整体答题情况和错误分析</p>
            </div>
            
            <!-- 教师登录 -->
            <div id="teacherLogin" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-sm text-center mb-10">
                <h3 class="text-xl font-semibold mb-6 text-dark">请输入教师密码</h3>
                <input type="password" id="teacherPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all mb-6" placeholder="输入密码">
                <button id="teacherLoginBtn" class="w-full px-4 py-3 bg-primary text-white rounded-lg btn-hover">
                    登录 <i class="fa fa-lock ml-2"></i>
                </button>
            </div>
            
            <!-- 教师仪表盘（初始隐藏） -->
            <div id="teacherDashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="p-5 border rounded-xl bg-blue-50 border-blue-100 transform transition-all hover:scale-105">
                        <div class="text-sm text-blue-600">参与学生数</div>
                        <div class="text-3xl font-bold text-blue-700 mt-2" id="totalStudents">0</div>
                    </div>
                    <div class="p-5 border rounded-xl bg-green-50 border-green-100 transform transition-all hover:scale-105">
                        <div class="text-sm text-green-600">全对人数</div>
                        <div class="text-3xl font-bold text-green-700 mt-2" id="fullCorrectStudents">0</div>
                    </div>
                    <div class="p-5 border rounded-xl bg-yellow-50 border-yellow-100 transform transition-all hover:scale-105">
                        <div class="text-sm text-yellow-600">平均正确率</div>
                        <div class="text-3xl font-bold text-yellow-700 mt-2" id="averageAccuracy">0%</div>
                    </div>
                    <div class="p-5 border rounded-xl bg-purple-50 border-purple-100 transform transition-all hover:scale-105">
                        <div class="text-sm text-purple-600">总答题次数</div>
                        <div class="text-3xl font-bold text-purple-700 mt-2" id="totalAttempts">0</div>
                    </div>
                </div>

                <!-- 热力图区域 -->
                <div class="mb-10">
                    <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                        <i class="fa fa-fire mr-2 text-orange-500"></i>各类型题目正确率热力图
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-5 rounded-xl text-center" id="heatBothEnds">
                            <div class="font-bold mb-3">两端都栽</div>
                            <div class="text-3xl" id="rateBothEnds">0%</div>
                        </div>
                        <div class="p-5 rounded-xl text-center" id="heatOneEnd">
                            <div class="font-bold mb-3">一端栽一端不栽</div>
                            <div class="text-3xl" id="rateOneEnd">0%</div>
                        </div>
                        <div class="p-5 rounded-xl text-center" id="heatNoEnd">
                            <div class="font-bold mb-3">两端都不栽</div>
                            <div class="text-3xl" id="rateNoEnd">0%</div>
                        </div>
                        <div class="p-5 rounded-xl text-center" id="heatCircle">
                            <div class="font-bold mb-3">封闭环形曲线</div>
                            <div class="text-3xl" id="rateCircle">0%</div>
                        </div>
                    </div>
                </div>

                <!-- 班级错题统计 -->
                <div class="mb-10">
                    <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                        <i class="fa fa-bar-chart mr-2 text-primary"></i>班级错题分布
                    </h3>
                    <div class="overflow-x-auto bg-light/30 rounded-xl p-1">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-white">
                                    <th class="px-6 py-4 border-b text-left">班级</th>
                                    <th class="px-6 py-4 border-b text-left">总人数</th>
                                    <th class="px-6 py-4 border-b text-left">全对人数</th>
                                    <th class="px-6 py-4 border-b text-left">错误率最高类型</th>
                                </tr>
                            </thead>
                            <tbody id="classErrorStats">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 border-b text-center">暂无数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 错题分析报告 -->
                <div>
                    <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                        <i class="fa fa-file-text mr-2 text-accent"></i>错题分析报告
                    </h3>
                    <div id="errorReport" class="border border-gray-200 rounded-xl p-5 bg-light/30">
                        <p class="mb-3">1. 各类型题目错误率统计：</p>
                        <ul id="errorRateList" class="list-disc ml-6 mb-6 space-y-1">
                            <li>两端都栽：0%（0/0人错误）</li>
                            <li>一端栽一端不栽：0%（0/0人错误）</li>
                            <li>两端都不栽：0%（0/0人错误）</li>
                            <li>封闭环形曲线：0%（0/0人错误）</li>
                        </ul>
                        <p class="mb-3">2. 主要错误原因：暂无数据</p>
                        <p class="mb-3">3. 教学建议：暂无数据</p>
                        <p class="text-sm text-neutral">数据更新时间：--</p>
                    </div>
                </div>
                
                <div class="mt-10 flex justify-center gap-4">
                    <button id="exportAnalysisBtn" class="px-6 py-3 bg-primary text-white rounded-lg btn-hover">
                        <i class="fa fa-download mr-2"></i>导出分析报告
                    </button>
                    <button id="clearDataBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg btn-hover">
                        <i class="fa fa-trash mr-2"></i>清空答题数据
                    </button>
                    <button id="teacherExitBtn" class="px-6 py-3 bg-neutral text-white rounded-lg btn-hover">
                        <i class="fa fa-sign-out mr-2"></i>退出
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 通知组件 -->
    <div id="notification" class="fixed top-20 right-5 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 max-w-xs"></div>

    <!-- 音效资源 -->
    <audio id="clapSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>
    
    <!-- 题库资源 -->
    <script src="question_bank.json" type="application/json" id="questionBank"></script>

    <script>
        // 全局数据存储（使用localStorage持久化）
        let studentRecords = JSON.parse(localStorage.getItem('plantingProblemRecords')) || [];
        let currentQuestion = 1;
        let studentInfo = { name: '', className: '' };
        let 答题开始时间 = null; // 记录整体答题开始时间
        // 存储各题目的独立数据，确保页面间数据不干扰
        let questionData = {};
        // 存储从题库加载的题目
        let selectedQuestions = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 角色切换功能
            document.getElementById('studentBtn').addEventListener('click', () => {
                document.getElementById('roleSelection').classList.add('hidden');
                document.getElementById('teacherInterface').classList.add('hidden');
                document.getElementById('studentInterface').classList.remove('hidden');
                updateRoleBtnStyles('student');
            });
            
            document.getElementById('teacherBtn').addEventListener('click', () => {
                document.getElementById('roleSelection').classList.add('hidden');
                document.getElementById('studentInterface').classList.add('hidden');
                document.getElementById('teacherInterface').classList.remove('hidden');
                document.getElementById('teacherDashboard').classList.add('hidden');
                document.getElementById('teacherLogin').classList.remove('hidden');
                updateRoleBtnStyles('teacher');
            });
            
            // 教师登录功能
            document.getElementById('teacherLoginBtn').addEventListener('click', () => {
                const password = document.getElementById('teacherPassword').value;
                // 简单密码验证（实际应用中应使用更安全的验证方式）
                if (password === 'teacher') {
                    document.getElementById('teacherLogin').classList.add('hidden');
                    document.getElementById('teacherDashboard').classList.remove('hidden');
                    updateTeacherDashboard();
                } else {
                    showNotification('密码错误，请重新输入', 'error');
                    document.getElementById('teacherPassword').classList.add('border-red-500');
                    setTimeout(() => {
                        document.getElementById('teacherPassword').classList.remove('border-red-500');
                    }, 2000);
                }
            });
            
            // 开始答题按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                const name = document.getElementById('studentName').value.trim();
                const className = document.getElementById('studentClass').value;
                
                if (!name) {
                    showNotification('请输入姓名', 'error');
                    document.getElementById('studentName').focus();
                    return;
                }
                
                if (!className) {
                    showNotification('请选择班级', 'error');
                    document.getElementById('studentClass').focus();
                    return;
                }
                
                // 保存学生信息
                studentInfo = { name, className };
                
                // 记录开始时间
                答题开始时间 = new Date();
                
                // 加载题库并生成题目
                loadQuestionBank();
                
                // 切换到题目页面（带动画）
                document.getElementById('studentHome').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('studentHome').classList.add('hidden');
                    document.getElementById('studentHome').classList.remove('opacity-0');
                    document.getElementById('questionPages').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('questionPages').classList.remove('opacity-0');
                    }, 50);
                }, 300);
                
                setActiveQuestion(1);
            });

            // 题目导航按钮
            document.querySelectorAll('.question-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const questionNum = parseInt(btn.getAttribute('data-question'));
                    // 保存当前页面数据
                    saveCurrentQuestionData();
                    // 切换到新题目
                    setActiveQuestion(questionNum);
                });
            });

            // 重新练习按钮
            document.getElementById('restartBtn').addEventListener('click', () => {
                // 重置当前会话数据
                questionData = {};
                selectedQuestions = [];
                
                // 重新加载题库
                loadQuestionBank();
                
                // 隐藏反馈，显示题目
                document.getElementById('resultFeedback').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('resultFeedback').classList.add('hidden');
                    document.getElementById('resultFeedback').classList.remove('opacity-0');
                    
                    // 重置当前问题为1
                    currentQuestion = 1;
                    setActiveQuestion(1);
                    
                    // 重置导航按钮样式
                    document.querySelectorAll('.question-nav-btn').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                        btn.classList.add('text-dark', 'border-gray-300');
                    });
                    document.querySelector(`.question-nav-btn[data-question="1"]`).classList.add('bg-primary', 'text-white', 'border-primary');
                    
                    // 记录新的开始时间
                    答题开始时间 = new Date();
                }, 300);
            });
            
            // 学生端退出按钮
            document.getElementById('studentExitBtn').addEventListener('click', function() {
                if (confirm('确定要退出吗？')) {
                    // 重置数据
                    questionData = {};
                    selectedQuestions = [];
                    studentInfo = { name: '', className: '' };
                    答题开始时间 = null;
                    
                    // 清空输入
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentClass').value = '';
                    
                    // 切换到角色选择界面
                    document.getElementById('questionPages').classList.add('hidden');
                    document.getElementById('studentInterface').classList.add('hidden');
                    document.getElementById('roleSelection').classList.remove('hidden');
                }
            });
            
            // 教师端退出按钮
            document.getElementById('teacherExitBtn').addEventListener('click', function() {
                document.getElementById('teacherInterface').classList.add('hidden');
                document.getElementById('roleSelection').classList.remove('hidden');
            });
            
            // 全屏切换功能
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullScreen);
        });

        // 加载题库并随机选择4道题
        function loadQuestionBank() {
            try {
                // 获取题库数据
                const bankElement = document.getElementById('questionBank');
                const questionBank = JSON.parse(bankElement.textContent);
                
                // 确保题库有足够的题目
                if (questionBank.length < 4) {
                    throw new Error('题库题目数量不足4道');
                }
                
                // 随机排序并选择前4道题
                selectedQuestions = [...questionBank]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 4);
                
                // 初始化题目数据存储
                selectedQuestions.forEach((q, index) => {
                    const questionNum = index + 1;
                    questionData[questionNum] = {
                        roadLength: '',
                        interval: '',
                        plantType: '',
                        calculation: ''
                    };
                });
                
                // 生成题目页面
                generateQuestionPages();
                // 生成题目表单
                generateQuestionForms();
            } catch (error) {
                console.error('加载题库失败:', error);
                // 加载失败时使用默认题目
                useDefaultQuestions();
            }
        }

        // 生成题目页面
        function generateQuestionPages() {
            const questionContent = document.getElementById('questionContent');
            questionContent.innerHTML = '';
            
            selectedQuestions.forEach((question, index) => {
                const questionNum = index + 1;
                const isLastQuestion = index === selectedQuestions.length - 1;
                
                const questionPage = document.createElement('div');
                questionPage.className = `question-page ${index === 0 ? '' : 'hidden'} page-transition`;
                questionPage.setAttribute('data-question', questionNum);
                
                questionPage.innerHTML = `
                    <div class="bg-light p-5 rounded-lg mb-6 border-l-4 border-primary">
                        <p class="text-lg md:text-xl">第${questionNum}题：${question.description}</p>
                    </div>
                    <div class="question-form" 
                         data-correct-length="${question.correctLength}" 
                         data-correct-interval="${question.correctInterval}" 
                         data-correct-type="${question.correctType}" 
                         data-correct-count="${question.correctCount}">
                    </div>
                    
                    <!-- 题目导航按钮 -->
                    <div class="mt-10 text-center">
                        ${!isLastQuestion ? `
                        <button class="next-question-btn px-8 py-4 bg-primary text-white rounded-lg btn-hover text-lg" data-next="${questionNum + 1}">
                            下一题 <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                        ` : `
                        <button id="checkAllBtn" class="px-8 py-4 bg-accent text-white rounded-lg btn-hover text-lg">
                            <i class="fa fa-check-circle mr-2"></i> 检验所有结果
                        </button>
                        `}
                    </div>
                `;
                
                questionContent.appendChild(questionPage);
            });
            
            // 重新绑定下一题按钮事件
            bindNextQuestionButtons();
            // 重新绑定检验按钮事件
            bindCheckButton();
        }

        // 绑定下一题按钮事件
        function bindNextQuestionButtons() {
            document.querySelectorAll('.next-question-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 验证当前题目是否填写完整
                    const currentQuestionPage = document.querySelector(`.question-page[data-question="${currentQuestion}"]`);
                    const roadLength = currentQuestionPage.querySelector('.road-length-input').value;
                    const interval = currentQuestionPage.querySelector('.interval-input').value;
                    const plantType = currentQuestionPage.querySelector('input[name="plantType"]:checked')?.value;
                    const calculation = currentQuestionPage.querySelector('.calculation-input').value;
                    
                    // 检查是否填写完整
                    if (!roadLength || !interval || !plantType || !calculation) {
                        showNotification('请先完成当前题目的所有内容再进入下一题', 'error');
                        return;
                    }
                    
                    // 保存当前页面数据
                    saveCurrentQuestionData();
                    
                    // 获取下一题编号并切换
                    const nextQuestion = parseInt(this.getAttribute('data-next'));
                    setActiveQuestion(nextQuestion);
                });
            });
        }

        // 绑定检验按钮事件
        function bindCheckButton() {
            const checkBtn = document.getElementById('checkAllBtn');
            if (checkBtn) {
                checkBtn.addEventListener('click', function() {
                    // 保存当前页面数据
                    saveCurrentQuestionData();
                    
                    // 防止重复点击
                    this.disabled = true;
                    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>检验中...';
                    
                    setTimeout(() => {
                        // 验证学生信息
                        if (!studentInfo.name || !studentInfo.className) {
                            showNotification('请先返回首页填写姓名和班级', 'error');
                            resetCheckButton();
                            return;
                        }

                        // 收集题目数据并检查是否填写完整
                        const allQuestionsData = [];
                        let allCompleted = true;
                        const incompleteQuestions = [];

                        for (let i = 1; i <= selectedQuestions.length; i++) {
                            const questionPage = document.querySelector(`.question-page[data-question="${i}"]`);
                            const form = questionPage.querySelector('.question-form');
                            
                            // 从存储中获取该题数据
                            const qData = questionData[i];
                            
                            const data = {
                                questionNum: i,
                                roadLength: qData.roadLength ? parseInt(qData.roadLength) : null,
                                interval: qData.interval ? parseInt(qData.interval) : null,
                                plantType: qData.plantType || null,
                                calculation: qData.calculation || '',
                                correctLength: parseInt(form.getAttribute('data-correct-length')),
                                correctInterval: parseInt(form.getAttribute('data-correct-interval')),
                                correctType: form.getAttribute('data-correct-type'),
                                correctCount: parseInt(form.getAttribute('data-correct-count'))
                            };

                            // 检查是否完成答题
                            if (!data.roadLength || !data.interval || !data.plantType || !data.calculation) {
                                allCompleted = false;
                                incompleteQuestions.push(i);
                            }

                            allQuestionsData.push(data);
                        }

                        // 未完成所有题目
                        if (!allCompleted) {
                            showNotification(`以下题目未完成：第${incompleteQuestions.join('、')}题，请先完成后再检验！`, 'error');
                            
                            // 高亮显示未完成的题目导航
                            document.querySelectorAll('.question-nav-btn').forEach(btn => {
                                const btnNum = parseInt(btn.getAttribute('data-question'));
                                if (incompleteQuestions.includes(btnNum)) {
                                    btn.classList.add('border-red-500', 'text-red-500', 'animate-pulse');
                                    // 3秒后移除动画
                                    setTimeout(() => {
                                        btn.classList.remove('animate-pulse');
                                    }, 3000);
                                }
                            });
                            
                            resetCheckButton();
                            return;
                        }

                        // 分析答题结果
                        const analysisResult = analyzeAnswers(allQuestionsData);
                        showResultFeedback(analysisResult);

                        // 记录答题记录
                        const 答题结束时间 = new Date();
                        const 答题时长 = Math.round((答题结束时间 - 答题开始时间) / 1000); // 秒

                        studentRecords.push({
                            studentInfo,
                            answers: allQuestionsData,
                            result: analysisResult,
                            startTime: 答题开始时间.toLocaleString(),
                            endTime: 答题结束时间.toLocaleString(),
                            duration: 答题时长 // 秒
                        });

                        // 保存数据
                        saveRecords();

                        // 实时更新教师端
                        if (!document.getElementById('teacherInterface').classList.contains('hidden')) {
                            updateTeacherDashboard();
                        }
                        
                        resetCheckButton();
                    }, 800);
                });
            }
        }

        // 重置检验按钮状态
        function resetCheckButton() {
            const checkBtn = document.getElementById('checkAllBtn');
            if (checkBtn) {
                checkBtn.disabled = false;
                checkBtn.innerHTML = '<i class="fa fa-check-circle mr-2"></i> 检验所有结果';
            }
        }

        // 当题库加载失败时使用默认题目
        function useDefaultQuestions() {
            selectedQuestions = [
                {
                    description: "小明家门前有一条20m长的小路，绿化队要在小路一旁栽一排树，每隔4m栽一棵树（两端都栽）。一共要栽多少棵树？",
                    correctLength: 20,
                    correctInterval: 4,
                    correctType: "bothEnds",
                    correctCount: 6
                },
                {
                    description: "小明家门前有一条35m长的小路，绿化队要在小路一旁栽一排树，每隔7m栽一棵树，一端靠墙。一共要栽多少棵树？",
                    correctLength: 35,
                    correctInterval: 7,
                    correctType: "oneEnd",
                    correctCount: 5
                },
                {
                    description: "小明家门前有一条60m长的小路，绿化队要在小路一旁栽一排树，每隔10m栽一棵树（两端都不栽）。一共要栽多少棵树？",
                    correctLength: 60,
                    correctInterval: 10,
                    correctType: "noEnd",
                    correctCount: 5
                },
                {
                    description: "小明家门前有一个周长30m长的花坛，爷爷要在花坛一周栽一排花，每隔6m栽一棵花。一共要栽多少棵花？",
                    correctLength: 30,
                    correctInterval: 6,
                    correctType: "circle",
                    correctCount: 5
                }
            ];
            
            // 初始化题目数据存储
            selectedQuestions.forEach((q, index) => {
                const questionNum = index + 1;
                questionData[questionNum] = {
                    roadLength: '',
                    interval: '',
                    plantType: '',
                    calculation: ''
                };
            });
            
            // 生成题目页面
            generateQuestionPages();
            // 生成题目表单
            generateQuestionForms();
        }

        // 保存当前题目的数据
        function saveCurrentQuestionData() {
            const questionPage = document.querySelector(`.question-page[data-question="${currentQuestion}"]`);
            
            questionData[currentQuestion] = {
                roadLength: questionPage.querySelector('.road-length-input').value,
                interval: questionPage.querySelector('.interval-input').value,
                plantType: questionPage.querySelector('input[name="plantType"]:checked')?.value || '',
                calculation: questionPage.querySelector('.calculation-input').value
            };
        }

        // 加载指定题目的数据
        function loadQuestionData(questionNum) {
            const questionPage = document.querySelector(`.question-page[data-question="${questionNum}"]`);
            const data = questionData[questionNum];
            
            questionPage.querySelector('.road-length-input').value = data.roadLength;
            questionPage.querySelector('.interval-input').value = data.interval;
            
            // 清除所有选中状态
            questionPage.querySelectorAll('input[name="plantType"]').forEach(radio => {
                radio.checked = false;
            });
            
            // 设置当前选中状态
            if (data.plantType) {
                const radio = questionPage.querySelector(`input[name="plantType"][value="${data.plantType}"]`);
                if (radio) radio.checked = true;
            }
            
            questionPage.querySelector('.calculation-input').value = data.calculation;
        }

        // 设置当前激活的题目
        function setActiveQuestion(questionNum) {
            // 如果正在切换题目，添加过渡效果
            const currentPage = document.querySelector(`.question-page:not(.hidden)`);
            currentPage.classList.add('opacity-0');
            
            setTimeout(() => {
                currentQuestion = questionNum;
                
                // 显示当前题目，隐藏其他题目
                document.querySelectorAll('.question-page').forEach(page => {
                    const pageNum = parseInt(page.getAttribute('data-question'));
                    if (pageNum === questionNum) {
                        page.classList.remove('hidden');
                        // 加载该题数据
                        loadQuestionData(questionNum);
                        setTimeout(() => {
                            page.classList.remove('opacity-0');
                        }, 50);
                    } else {
                        page.classList.add('hidden');
                        page.classList.remove('opacity-0');
                    }
                });
                
                // 更新导航按钮样式
                document.querySelectorAll('.question-nav-btn').forEach(btn => {
                    const btnNum = parseInt(btn.getAttribute('data-question'));
                    // 移除错误高亮
                    btn.classList.remove('border-red-500', 'text-red-500');
                    
                    if (btnNum === questionNum) {
                        btn.classList.add('bg-primary', 'text-white', 'border-primary');
                        btn.classList.remove('text-dark', 'border-gray-300');
                    } else {
                        btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                        btn.classList.add('text-dark', 'border-gray-300');
                    }
                });
                
                // 绑定绘制按钮事件
                bindDrawButtons();
            }, 300);
        }

        // 更新角色按钮样式
        function updateRoleBtnStyles(activeRole) {
            if (activeRole === 'student') {
                document.getElementById('studentBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('studentBtn').classList.remove('bg-white', 'text-dark');
                document.getElementById('teacherBtn').classList.add('bg-white', 'text-dark');
                document.getElementById('teacherBtn').classList.remove('bg-primary', 'text-white');
            } else {
                document.getElementById('teacherBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('teacherBtn').classList.remove('bg-white', 'text-dark');
                document.getElementById('studentBtn').classList.add('bg-white', 'text-dark');
                document.getElementById('studentBtn').classList.remove('bg-primary', 'text-white');
            }
        }

        // 生成题目表单
        function generateQuestionForms() {
            const template = document.getElementById('questionFormTemplate').innerHTML;
            document.querySelectorAll('.question-form').forEach(form => {
                form.innerHTML = template;
            });
            
            // 绑定绘制按钮事件
            bindDrawButtons();
        }

        // 绑定绘制按钮事件
        function bindDrawButtons() {
            document.querySelectorAll('.draw-btn').forEach(btn => {
                // 先移除已有的事件监听，避免重复绑定
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function() {
                    const questionPage = this.closest('.question-page');
                    const roadLength = parseInt(questionPage.querySelector('.road-length-input').value);
                    const interval = parseInt(questionPage.querySelector('.interval-input').value);
                    const plantType = questionPage.querySelector('input[name="plantType"]:checked')?.value;
                    const canvas = questionPage.querySelector('.plant-canvas');

                    // 输入验证
                    if (!roadLength || !interval || !plantType) {
                        showNotification('请先填写道路长度、间隔距离并选择植树类型！', 'error');
                        return;
                    }
                    if (roadLength <= 0 || interval <= 0) {
                        showNotification('道路长度和间隔距离必须为正数！', 'error');
                        return;
                    }
                    if (roadLength < interval) {
                        showNotification('道路长度不能小于间隔距离！', 'error');
                        return;
                    }

                    // 清空画布
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // 添加绘制动画
                    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>绘制中...';
                    
                    setTimeout(() => {
                        // 根据类型绘制不同示意图
                        switch (plantType) {
                            case 'bothEnds':
                                drawLinear(canvas, roadLength, interval, true, true);
                                break;
                            case 'oneEnd':
                                drawLinear(canvas, roadLength, interval, true, false);
                                break;
                            case 'noEnd':
                                drawLinear(canvas, roadLength, interval, false, false);
                                break;
                            case 'circle':
                                drawCircle(canvas, roadLength, interval);
                                break;
                        }
                        
                        this.innerHTML = '<i class="fa fa-paint-brush mr-2"></i>绘制示意图';
                        showNotification('示意图绘制完成', 'success');
                    }, 600);
                });
            });
        }

        // 绘制直线形植树示意图
        function drawLinear(canvas, roadLength, interval, startPlant, endPlant) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 计算缩放比例，确保能在画布上显示完整
            const scale = (width - 80) / roadLength; // 两边留40px边距
            const segmentCount = Math.floor(roadLength / interval);
            
            // 绘制地面
            ctx.fillStyle = '#E0F2FE';
            ctx.fillRect(40, height - 60, width - 80, 40);
            
            // 绘制间隔线
            ctx.strokeStyle = '#94A3B8';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 3]);
            
            for (let i = 0; i <= segmentCount; i++) {
                const x = 40 + i * interval * scale;
                
                // 垂直线
                ctx.beginPath();
                ctx.moveTo(x, height - 60);
                ctx.lineTo(x, height - 40);
                ctx.stroke();
                
                // 距离标注
                if (i > 0) {
                    ctx.fillStyle = '#64748B';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${interval}m`, x - interval * scale / 2, height - 20);
                }
            }
            
            // 绘制起点和终点
            ctx.fillStyle = '#64748B';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('起点', 40, height - 70);
            ctx.fillText('终点', 40 + roadLength * scale, height - 70);
            
            // 重置线条样式
            ctx.setLineDash([]);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#334155';
            
            // 绘制道路线
            ctx.beginPath();
            ctx.moveTo(40, height - 40);
            ctx.lineTo(40 + roadLength * scale, height - 40);
            ctx.stroke();
            
            // 绘制树
            let treeIndex = 0;
            const drawTree = (x) => {
                setTimeout(() => {
                    // 树干
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x - 3, height - 60, 6, 20);
                    
                    // 树叶
                    ctx.fillStyle = '#22C55E';
                    ctx.beginPath();
                    ctx.arc(x, height - 70, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    treeIndex++;
                }, treeIndex * 100);
            };
            
            // 根据类型决定是否在起点和终点种树
            if (startPlant) {
                drawTree(40);
            }
            
            // 中间的树
            for (let i = 1; i < segmentCount; i++) {
                drawTree(40 + i * interval * scale);
            }
            
            // 终点的树
            if (endPlant) {
                drawTree(40 + roadLength * scale);
            }
        }

        // 绘制环形植树示意图
        function drawCircle(canvas, circumference, interval) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 计算圆的半径
            const radius = Math.min(width, height) / 3;
            const centerX = width / 2;
            const centerY = height / 2;
            const plantCount = circumference / interval;
            
            // 绘制环形
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#94A3B8';
            ctx.lineWidth = 20;
            ctx.stroke();
            
            // 绘制间隔标注
            ctx.fillStyle = '#64748B';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 绘制树
            let treeIndex = 0;
            const drawTree = (angle) => {
                setTimeout(() => {
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    
                    // 树干
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x - 3, y - 10, 6, 20);
                    
                    // 树叶
                    ctx.fillStyle = '#22C55E';
                    ctx.beginPath();
                    ctx.arc(x, y - 10, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    treeIndex++;
                }, treeIndex * 100);
            };
            
            // 计算每个植物的角度
            for (let i = 0; i < plantCount; i++) {
                const angle = (i / plantCount) * Math.PI * 2;
                drawTree(angle);
                
                // 绘制间隔标注线
                const labelAngle = ((i + 0.5) / plantCount) * Math.PI * 2;
                const labelX = centerX + (radius + 20) * Math.cos(labelAngle);
                const labelY = centerY + (radius + 20) * Math.sin(labelAngle);
                ctx.fillText(`${interval}m`, labelX, labelY);
            }
            
            // 标注周长
            ctx.font = '14px Arial';
            ctx.fillText(`周长: ${circumference}m`, centerX, centerY);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // 设置样式
            notification.className = 'fixed top-20 right-5 p-4 rounded-lg shadow-lg transform transition-transform duration-300 z-50 max-w-xs';
            
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                    break;
                case 'error':
                    notification.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                    addShakeAnimation(notification);
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                    break;
                default:
                    notification.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
            }
            
            // 显示通知
            notification.style.transform = 'translateX(0)';
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.style.transform = 'translateX(calc(100% + 20px))';
            }, 3000);
        }

        // 添加抖动动画
        function addShakeAnimation(element) {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                .animate-shake {
                    animation: shake 0.5s ease-in-out;
                }
                .animate-pulse {
                    animation: pulse 1s ease-in-out infinite;
                }
            `;
            document.head.appendChild(style);
            element.classList.add('animate-shake');
            setTimeout(() => {
                element.classList.remove('animate-shake');
                document.head.removeChild(style);
            }, 500);
        }

        // 分析答题结果（增强版，支持更深入的错误模式识别）
        function analyzeAnswers(questionsData) {
            const result = {
                totalCorrect: 0,
                questionResults: [],
                allCorrect: false,
                errorPatterns: [], // 错误模式识别
                mainErrorType: null // 主要错误类型
            };

            // 先收集每个题目的基本错误信息
            questionsData.forEach(question => {
                // 验证道路长度和间隔
                const lengthCorrect = question.roadLength === question.correctLength;
                const intervalCorrect = question.interval === question.correctInterval;
                const typeCorrect = question.plantType === question.correctType;
                
                // 提取学生答案中的数字和公式
                const studentResultMatch = question.calculation.match(/(\d+)(?=\（棵\）|棵|株|个|朵)/);
                const studentResult = studentResultMatch ? parseInt(studentResultMatch[1]) : null;
                const countCorrect = studentResult === question.correctCount;
                
                // 提取使用的公式类型（+1, -1, 或直接除）
                let formulaType = null;
                if (question.calculation.includes('+1')) formulaType = 'add1';
                else if (question.calculation.includes('-1')) formulaType = 'subtract1';
                else if (question.calculation.includes('÷') || question.calculation.includes('/')) formulaType = 'divideOnly';

                // 题目是否正确（所有要素都正确）
                const questionCorrect = lengthCorrect && intervalCorrect && typeCorrect && countCorrect;
                if (questionCorrect) result.totalCorrect++;

                // 记录错误原因
                const errorReasons = [];
                if (!lengthCorrect) errorReasons.push(`道路长度输入错误（正确应为${question.correctLength}米）`);
                if (!intervalCorrect) errorReasons.push(`间隔距离输入错误（正确应为${question.correctInterval}米）`);
                if (!typeCorrect) errorReasons.push(`植树类型选择错误（正确应为${getPlantTypeName(question.correctType)}）`);
                if (!countCorrect) {
                    if (studentResult === null) {
                        errorReasons.push('未正确填写计算结果（需包含数字和单位）');
                    } else {
                        errorReasons.push(`计算结果错误（正确应为${question.correctCount}${question.questionNum === 4 ? '朵' : '棵'}）`);
                    }
                }

                // 记录题目结果
                result.questionResults.push({
                    questionNum: question.questionNum,
                    correct: questionCorrect,
                    errorReasons,
                    correctType: question.correctType,
                    selectedType: question.plantType,
                    correctCount: question.correctCount,
                    studentResult,
                    formulaType,
                    correctFormulaType: getCorrectFormulaType(question.correctType)
                });
            });

            // 分析错误模式（综合所有题目）
            analyzeErrorPatterns(result);

            // 判断是否全对
            result.allCorrect = result.totalCorrect === 4;

            return result;
        }

        // 获取正确的公式类型
        function getCorrectFormulaType(plantType) {
            switch (plantType) {
                case 'bothEnds': return 'add1'; // 间隔数+1
                case 'oneEnd': return 'divideOnly'; // 间隔数
                case 'noEnd': return 'subtract1'; // 间隔数-1
                case 'circle': return 'divideOnly'; // 间隔数（与一端栽相同）
            }
        }

        // 分析错误模式（综合所有题目）
        function analyzeErrorPatterns(result) {
            // 1. 检查是否混淆了两端栽和一端栽的模型
            const bothEndsQuestion = result.questionResults.find(q => q.correctType === 'bothEnds');
            const oneEndQuestion = result.questionResults.find(q => q.correctType === 'oneEnd');
            
            if (bothEndsQuestion && !bothEndsQuestion.correct && 
                oneEndQuestion && !oneEndQuestion.correct &&
                bothEndsQuestion.formulaType === 'divideOnly' && 
                oneEndQuestion.formulaType === 'divideOnly') {
                result.errorPatterns.push('无法区分"两端栽树"与"一端栽一端不栽"模型的不同，都使用了相同的公式（仅用间隔数）进行计算');
            }
            
            // 2. 检查是否所有题目都使用了相同的公式
            const formulaTypes = new Set();
            result.questionResults.forEach(q => {
                if (q.formulaType) formulaTypes.add(q.formulaType);
            });
            
            if (formulaTypes.size === 1 && result.totalCorrect < 4) {
                result.errorPatterns.push('对所有类型的题目都使用了相同的计算公式，没有根据实际情况调整');
            }
            
            // 3. 检查是否混淆了封闭环形与其他类型
            const circleQuestion = result.questionResults.find(q => q.correctType === 'circle');
            if (circleQuestion && !circleQuestion.correct) {
                if (circleQuestion.formulaType === 'add1') {
                    result.errorPatterns.push('将封闭环形栽树错误地按照"两端都栽"的公式计算（间隔数+1）');
                } else if (circleQuestion.formulaType === 'subtract1') {
                    result.errorPatterns.push('将封闭环形栽树错误地按照"两端都不栽"的公式计算（间隔数-1）');
                }
            }
            
            // 4. 确定主要错误类型
            const errorTypeCount = {};
            result.questionResults.forEach(q => {
                if (!q.correct) {
                    errorTypeCount[q.correctType] = (errorTypeCount[q.correctType] || 0) + 1;
                }
            });
            
            if (Object.keys(errorTypeCount).length > 0) {
                result.mainErrorType = Object.entries(errorTypeCount).sort((a, b) => b[1] - a[1])[0][0];
            }
        }

        // 显示结果反馈
        function showResultFeedback(analysisResult) {
            const resultFeedback = document.getElementById('resultFeedback');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackContent = document.getElementById('feedbackContent');
            const errorExercises = document.getElementById('errorExercises');
            const exercisesList = document.querySelector('.exercises-list');

            // 清空之前的内容
            feedbackContent.innerHTML = '';
            exercisesList.innerHTML = '';

            if (analysisResult.allCorrect) {
                // 全对
                resultFeedback.className = 'mt-10 p-6 rounded-xl border border-green-200 bg-green-50 hidden page-transition';
                feedbackTitle.textContent = '恭喜你！所有题目都答对了！';
                feedbackTitle.className = 'text-2xl font-bold mb-6 text-center text-green-600';
                feedbackContent.innerHTML = `
                    <p class="text-center mb-6">你对四种植树问题的理解非常透彻，能够根据不同场景选择正确的计算方法，真棒！</p>
                    <div class="text-center bg-white p-4 rounded-lg inline-block mx-auto">
                        <p class="text-neutral">答题总时长：${Math.floor(studentRecords[studentRecords.length-1].duration / 60)}分${studentRecords[studentRecords.length-1].duration % 60}秒</p>
                    </div>
                `;
                errorExercises.classList.add('hidden');
                
                // 播放音效和散花
                document.getElementById('clapSound').play();
                createConfetti();
            } else {
                // 有错
                resultFeedback.className = 'mt-10 p-6 rounded-xl border border-orange-200 bg-orange-50 hidden page-transition';
                feedbackTitle.textContent = `共完成4题，正确${analysisResult.totalCorrect}题，错误${4 - analysisResult.totalCorrect}题`;
                feedbackTitle.className = 'text-2xl font-bold mb-6 text-center text-orange-600';
                
                // 生成错误题目列表
                const errorList = document.createElement('ul');
                errorList.className = 'list-disc ml-6 space-y-4';
                
                analysisResult.questionResults.forEach(question => {
                    if (!question.correct) {
                        const li = document.createElement('li');
                        li.className = 'p-3 border-l-4 border-red-300 bg-white rounded-r-lg';
                        li.innerHTML = `
                            <strong>第${question.questionNum}题（${getPlantTypeName(question.correctType)}）：</strong>
                            <ul class="list-circle ml-6 mt-2 text-sm space-y-1">
                                ${question.errorReasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                            <div class="mt-2 text-sm text-green-600">正确解法：${getCorrectFormula(question)}</div>
                        `;
                        errorList.appendChild(li);
                    }
                });
                
                feedbackContent.appendChild(errorList);
                
                // 显示错误模式分析
                if (analysisResult.errorPatterns.length > 0) {
                    const patternDiv = document.createElement('div');
                    patternDiv.className = 'mt-6 p-4 bg-white rounded-lg border border-blue-100';
                    patternDiv.innerHTML = `
                        <h4 class="font-semibold text-blue-700 mb-2">错误模式分析：</h4>
                        <ul class="list-disc ml-6 space-y-1 text-sm">
                            ${analysisResult.errorPatterns.map(pattern => `<li>${pattern}</li>`).join('')}
                        </ul>
                    `;
                    feedbackContent.appendChild(patternDiv);
                }
                
                // 生成针对性练习
                if (analysisResult.mainErrorType) {
                    errorExercises.classList.remove('hidden');
                    generateExercises(analysisResult.mainErrorType, exercisesList);
                }
            }
            
            // 显示反馈区域（带动画）
            setTimeout(() => {
                resultFeedback.classList.remove('hidden');
                setTimeout(() => {
                    resultFeedback.classList.remove('opacity-0');
                }, 50);
            }, 300);
            
            // 滚动到反馈区域
            resultFeedback.scrollIntoView({ behavior: 'smooth' });
        }

        // 获取植树类型名称
        function getPlantTypeName(type) {
            const typeNames = {
                'bothEnds': '两端都栽',
                'oneEnd': '一端栽一端不栽',
                'noEnd': '两端都不栽',
                'circle': '封闭环形'
            };
            return typeNames[type] || type;
        }

        // 获取正确的公式描述
        function getCorrectFormula(question) {
            const length = question.correctLength;
            const interval = question.correctInterval;
            const count = question.correctCount;
            const segments = length / interval;
            
            // 使用标准数学符号
            switch (question.correctType) {
                case 'bothEnds':
                    return `${length} ÷ ${interval} = ${segments}（间隔），${segments} + 1 = ${count}（棵）（两端都栽需加1）`;
                case 'oneEnd':
                    return `${length} ÷ ${interval} = ${segments}（间隔），棵数 = 间隔数 = ${count}（棵）（一端栽无需加减）`;
                case 'noEnd':
                    return `${length} ÷ ${interval} = ${segments}（间隔），${segments} - 1 = ${count}（棵）（两端都不栽需减1）`;
                case 'circle':
                    return `${length} ÷ ${interval} = ${segments}（间隔），棵数 = 间隔数 = ${count}（朵）（环形栽树与一端栽相同）`;
            }
        }

        // 生成散花效果
        function createConfetti() {
            const confettiCount = 200;
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '100';
            document.body.appendChild(container);
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                const size = Math.random() * 10 + 5;
                
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.position = 'absolute';
                confetti.style.top = `-${size}px`;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animation = `confetti ${Math.random() * 3 + 2}s linear forwards`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.opacity = Math.random() * 0.7 + 0.3;
                
                container.appendChild(confetti);
            }
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes confetti {
                    0% {
                        transform: translateY(0) rotate(0deg);
                        opacity: 1;
                    }
                    100% {
                        transform: translateY(100vh) rotate(720deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // 3秒后清理
            setTimeout(() => {
                document.body.removeChild(container);
                document.head.removeChild(style);
            }, 3000);
        }

        // 生成针对性练习
        function generateExercises(mainType, container) {
            // 练习类型分布：主要错误类型2题，其他类型1题
            const exerciseTypes = [mainType, mainType];
            const otherTypes = ['bothEnds', 'oneEnd', 'noEnd', 'circle'].filter(type => type !== mainType);
            exerciseTypes.push(otherTypes[Math.floor(Math.random() * otherTypes.length)]);

            // 生成练习
            exerciseTypes.forEach((type, index) => {
                const interval = Math.floor(Math.random() * 5) + 3; // 3-7米
                const segmentCount = Math.floor(Math.random() * 7) + 4; // 4-10段
                const roadLength = interval * segmentCount;
                
                let correctCount, description;
                switch (type) {
                    case 'bothEnds':
                        correctCount = segmentCount + 1;
                        description = `有一条${roadLength}米长的小路，在路的一旁栽树，每隔${interval}米栽一棵，两端都要栽。一共要栽多少棵树？`;
                        break;
                    case 'oneEnd':
                        correctCount = segmentCount;
                        description = `有一条${roadLength}米长的小路，一端连接建筑物，在路的另一旁栽树，每隔${interval}米栽一棵。一共要栽多少棵树？`;
                        break;
                    case 'noEnd':
                        correctCount = segmentCount - 1;
                        description = `有一条${roadLength}米长的小路，两端都有障碍物，在路的一旁栽树，每隔${interval}米栽一棵。一共要栽多少棵树？`;
                        break;
                    case 'circle':
                        correctCount = segmentCount;
                        description = `有一个周长为${roadLength}米的圆形花坛，要在花坛周围栽花，每隔${interval}米栽一株。一共要栽多少株花？`;
                        break;
                }
                
                const exercise = document.createElement('div');
                exercise.className = 'p-4 border border-gray-200 rounded-lg bg-white';
                exercise.innerHTML = `
                    <p class="font-medium mb-2">练习${index + 1}（${getPlantTypeName(type)}）：${description}</p>
                    <div class="text-green-600 text-sm">参考答案：${correctCount}${type === 'circle' ? '株' : '棵'}</div>
                    <div class="text-xs text-neutral mt-1">解题思路：${getCorrectFormula({
                        correctType: type,
                        correctLength: roadLength,
                        correctInterval: interval,
                        correctCount: correctCount
                    })}</div>
                `;
                container.appendChild(exercise);
            });
        }

        // 保存记录到localStorage
        function saveRecords() {
            localStorage.setItem('plantingProblemRecords', JSON.stringify(studentRecords));
        }

        // 更新教师仪表盘
        function updateTeacherDashboard() {
            if (studentRecords.length === 0) {
                // 清空数据时的显示
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('fullCorrectStudents').textContent = '0';
                document.getElementById('averageAccuracy').textContent = '0%';
                document.getElementById('totalAttempts').textContent = '0';
                
                // 重置热力图
                document.getElementById('rateBothEnds').textContent = '0%';
                document.getElementById('rateOneEnd').textContent = '0%';
                document.getElementById('rateNoEnd').textContent = '0%';
                document.getElementById('rateCircle').textContent = '0%';
                
                // 重置表格
                const classErrorStats = document.getElementById('classErrorStats');
                classErrorStats.innerHTML = '<tr><td colspan="4" class="px-6 py-4 border-b text-center">暂无数据</td></tr>';
                
                // 重置报告
                document.getElementById('errorReport').innerHTML = `
                    <p class="mb-3">1. 各类型题目错误率统计：</p>
                    <ul id="errorRateList" class="list-disc ml-6 mb-6 space-y-1">
                        <li>两端都栽：0%（0/0人错误）</li>
                        <li>一端栽一端不栽：0%（0/0人错误）</li>
                        <li>两端都不栽：0%（0/0人错误）</li>
                        <li>封闭环形曲线：0%（0/0人错误）</li>
                    </ul>
                    <p class="mb-3">2. 主要错误原因：暂无数据</p>
                    <p class="mb-3">3. 教学建议：暂无数据</p>
                    <p class="text-sm text-neutral">数据更新时间：--</p>
                `;
                return;
            }
            
            // 1. 基本统计
            const totalStudents = new Set(studentRecords.map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const fullCorrectStudents = new Set(studentRecords.filter(r => r.result.allCorrect).map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const totalAttempts = studentRecords.length;
            
            let totalCorrectCount = 0;
            studentRecords.forEach(r => {
                totalCorrectCount += r.result.totalCorrect;
            });
            const averageAccuracy = Math.round((totalCorrectCount / (totalAttempts * 4)) * 100);
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('fullCorrectStudents').textContent = fullCorrectStudents;
            document.getElementById('averageAccuracy').textContent = `${averageAccuracy}%`;
            document.getElementById('totalAttempts').textContent = totalAttempts;

            // 2. 各类型题目正确率
            const typeStats = {
                bothEnds: { total: 0, correct: 0 },
                oneEnd: { total: 0, correct: 0 },
                noEnd: { total: 0, correct: 0 },
                circle: { total: 0, correct: 0 }
            };

            studentRecords.forEach(record => {
                record.result.questionResults.forEach(q => {
                    typeStats[q.correctType].total++;
                    if (q.correct) {
                        typeStats[q.correctType].correct++;
                    }
                });
            });

            // 更新热力图
            for (const type in typeStats) {
                const stats = typeStats[type];
                const rate = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
                const rateElem = document.getElementById(`rate${type.charAt(0).toUpperCase() + type.slice(1)}`);
                const heatElem = document.getElementById(`heat${type.charAt(0).toUpperCase() + type.slice(1)}`);

                rateElem.textContent = `${rate}%`;
                
                // 热力图颜色（红色=低正确率，绿色=高正确率）
                let colorClass = '';
                if (rate >= 80) {
                    colorClass = 'bg-green-50 border-green-200 text-green-700';
                } else if (rate >= 60) {
                    colorClass = 'bg-yellow-50 border-yellow-200 text-yellow-700';
                } else if (rate >= 40) {
                    colorClass = 'bg-orange-50 border-orange-200 text-orange-700';
                } else {
                    colorClass = 'bg-red-50 border-red-200 text-red-700';
                }
                
                heatElem.className = `p-5 rounded-xl text-center ${colorClass}`;
            }

            // 3. 班级统计
            const classStats = {};
            studentRecords.forEach(record => {
                const className = record.studentInfo.className;
                const studentId = `${record.studentInfo.name}-${className}`;
                
                if (!classStats[className]) {
                    classStats[className] = {
                        totalStudents: 0,
                        fullCorrect: 0,
                        students: new Set(),
                        errorTypes: {}
                    };
                }
                
                // 记录学生
                if (!classStats[className].students.has(studentId)) {
                    classStats[className].students.add(studentId);
                    classStats[className].totalStudents = classStats[className].students.size;
                }
                
                // 记录全对
                if (record.result.allCorrect && !classStats[className].students.has(`${studentId}-correct`)) {
                    classStats[className].fullCorrect++;
                    classStats[className].students.add(`${studentId}-correct`);
                }
            });
            
            // 统计班级错误类型
            studentRecords.forEach(record => {
                const className = record.studentInfo.className;
                record.result.questionResults.forEach(q => {
                    if (!q.correct) {
                        classStats[className].errorTypes[q.correctType] = (classStats[className].errorTypes[q.correctType] || 0) + 1;
                    }
                });
            });

            // 更新班级统计表格
            const classErrorStats = document.getElementById('classErrorStats');
            classErrorStats.innerHTML = '';
            
            Object.entries(classStats).forEach(([className, stats]) => {
                // 找出错误率最高的类型
                let maxErrorType = '';
                let maxCount = 0;
                Object.entries(stats.errorTypes).forEach(([type, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        maxErrorType = type;
                    }
                });

                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-light/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 border-b">${className}</td>
                    <td class="px-6 py-4 border-b">${stats.totalStudents}</td>
                    <td class="px-6 py-4 border-b">${stats.fullCorrect}</td>
                    <td class="px-6 py-4 border-b">${maxErrorType ? getPlantTypeName(maxErrorType) : '无'}</td>
                `;
                classErrorStats.appendChild(row);
            });

            // 4. 更新错误分析报告
            const errorRateList = document.getElementById('errorRateList');
            errorRateList.innerHTML = '';
            
            for (const type in typeStats) {
                const stats = typeStats[type];
                const errorCount = stats.total - stats.correct;
                const errorRate = stats.total === 0 ? 0 : Math.round((errorCount / stats.total) * 100);
                
                const li = document.createElement('li');
                li.textContent = `${getPlantTypeName(type)}：${errorRate}%（${errorCount}/${stats.total}人错误）`;
                errorRateList.appendChild(li);
            }
            
            // 主要错误原因分析
            let mainErrorReason = "暂无明显错误模式";
            let teachingSuggestion = "建议加强各类植树问题的概念理解和公式应用练习。";
            
            // 找出错误率最高的类型
            let maxErrorRate = 0;
            let maxErrorType = '';
            for (const type in typeStats) {
                const stats = typeStats[type];
                const errorRate = stats.total === 0 ? 0 : (stats.total - stats.correct) / stats.total;
                if (errorRate > maxErrorRate) {
                    maxErrorRate = errorRate;
                    maxErrorType = type;
                }
            }
            
            if (maxErrorType) {
                // 根据错误类型给出分析和建议
                switch (maxErrorType) {
                    case 'bothEnds':
                        mainErrorReason = `学生在"两端都栽"类型的题目中错误率最高，主要是忘记在间隔数基础上加1。`;
                        teachingSuggestion = `重点讲解"两端都栽"时"棵数=间隔数+1"的原理，可以通过实际画图演示帮助学生理解为什么需要加1。`;
                        break;
                    case 'oneEnd':
                        mainErrorReason = `学生在"一端栽一端不栽"类型的题目中错误率最高，常错误地加1或减1。`;
                        teachingSuggestion = `通过对比教学，强调"一端栽一端不栽"时"棵数=间隔数"的特点，可以与其他类型进行对比练习。`;
                        break;
                    case 'noEnd':
                        mainErrorReason = `学生在"两端都不栽"类型的题目中错误率最高，主要是忘记在间隔数基础上减1。`;
                        teachingSuggestion = `重点讲解"两端都不栽"时"棵数=间隔数-1"的原理，可以通过实际案例说明为什么需要减1。`;
                        break;
                    case 'circle':
                        mainErrorReason = `学生在"封闭环形"类型的题目中错误率最高，常与直线型植树问题混淆。`;
                        teachingSuggestion = `强调封闭图形植树与"一端栽一端不栽"的一致性，即"棵数=间隔数"，可以通过实物演示帮助理解。`;
                        break;
                }
            }
            
            // 更新报告内容
            document.getElementById('errorReport').innerHTML = `
                <p class="mb-3">1. 各类型题目错误率统计：</p>
                ${errorRateList.outerHTML}
                <p class="mb-3">2. 主要错误原因：${mainErrorReason}</p>
                <p class="mb-3">3. 教学建议：${teachingSuggestion}</p>
                <p class="text-sm text-neutral">数据更新时间：${new Date().toLocaleString()}</p>
            `;
        }

        // 教师端导出分析报告
        document.getElementById('exportAnalysisBtn').addEventListener('click', function() {
            if (studentRecords.length === 0) {
                showNotification('没有可导出的分析数据', 'error');
                return;
            }
            
            // 生成分析报告文本
            let reportText = "植树问题教学分析报告\n";
            reportText += "生成时间: " + new Date().toLocaleString() + "\n\n";
            
            // 添加整体统计
            const totalStudents = new Set(studentRecords.map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const fullCorrectStudents = new Set(studentRecords.filter(r => r.result.allCorrect).map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const totalAttempts = studentRecords.length;
            
            let totalCorrectCount = 0;
            studentRecords.forEach(r => {
                totalCorrectCount += r.result.totalCorrect;
            });
            const averageAccuracy = Math.round((totalCorrectCount / (totalAttempts * 4)) * 100);
            
            reportText += "一、整体统计\n";
            reportText += `1. 参与学生数: ${totalStudents}\n`;
            reportText += `2. 全对人数: ${fullCorrectStudents}\n`;
            reportText += `3. 平均正确率: ${averageAccuracy}%\n`;
            reportText += `4. 总答题次数: ${totalAttempts}\n\n`;
            
            // 添加各类型题目统计
            const typeStats = {
                bothEnds: { total: 0, correct: 0 },
                oneEnd: { total: 0, correct: 0 },
                noEnd: { total: 0, correct: 0 },
                circle: { total: 0, correct: 0 }
            };

            studentRecords.forEach(record => {
                record.result.questionResults.forEach(q => {
                    typeStats[q.correctType].total++;
                    if (q.correct) {
                        typeStats[q.correctType].correct++;
                    }
                });
            });
            
            reportText += "二、各类型题目正确率\n";
            for (const type in typeStats) {
                const stats = typeStats[type];
                const rate = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
                reportText += `${getPlantTypeName(type)}: ${rate}% (${stats.correct}/${stats.total}正确)\n`;
            }
            reportText += "\n";
            
            // 添加班级统计
            const classStats = {};
            studentRecords.forEach(record => {
                const className = record.studentInfo.className;
                const studentId = `${record.studentInfo.name}-${className}`;
                
                if (!classStats[className]) {
                    classStats[className] = {
                        totalStudents: 0,
                        fullCorrect: 0,
                        students: new Set()
                    };
                }
                
                if (!classStats[className].students.has(studentId)) {
                    classStats[className].students.add(studentId);
                    classStats[className].totalStudents = classStats[className].students.size;
                }
                
                if (record.result.allCorrect && !classStats[className].students.has(`${studentId}-correct`)) {
                    classStats[className].fullCorrect++;
                    classStats[className].students.add(`${studentId}-correct`);
                }
            });
            
            reportText += "三、班级统计\n";
            reportText += "班级\t总人数\t全对人数\n";
            Object.entries(classStats).forEach(([className, stats]) => {
                reportText += `${className}\t${stats.totalStudents}\t${stats.fullCorrect}\n`;
            });
            reportText += "\n";
            
            // 添加错误分析
            let mainErrorReason = "暂无明显错误模式";
            let teachingSuggestion = "建议加强各类植树问题的概念理解和公式应用练习。";
            
            let maxErrorRate = 0;
            let maxErrorType = '';
            for (const type in typeStats) {
                const stats = typeStats[type];
                const errorRate = stats.total === 0 ? 0 : (stats.total - stats.correct) / stats.total;
                if (errorRate > maxErrorRate) {
                    maxErrorRate = errorRate;
                    maxErrorType = type;
                }
            }
            
            if (maxErrorType) {
                switch (maxErrorType) {
                    case 'bothEnds':
                        mainErrorReason = `学生在"两端都栽"类型的题目中错误率最高，主要是忘记在间隔数基础上加1。`;
                        teachingSuggestion = `重点讲解"两端都栽"时"棵数=间隔数+1"的原理，可以通过实际画图演示帮助学生理解为什么需要加1。`;
                        break;
                    case 'oneEnd':
                        mainErrorReason = `学生在"一端栽一端不栽"类型的题目中错误率最高，常错误地加1或减1。`;
                        teachingSuggestion = `通过对比教学，强调"一端栽一端不栽"时"棵数=间隔数"的特点，可以与其他类型进行对比练习。`;
                        break;
                    case 'noEnd':
                        mainErrorReason = `学生在"两端都不栽"类型的题目中错误率最高，主要是忘记在间隔数基础上减1。`;
                        teachingSuggestion = `重点讲解"两端都不栽"时"棵数=间隔数-1"的原理，可以通过实际案例说明为什么需要减1。`;
                        break;
                    case 'circle':
                        mainErrorReason = `学生在"封闭环形"类型的题目中错误率最高，常与直线型植树问题混淆。`;
                        teachingSuggestion = `强调封闭图形植树与"一端栽一端不栽"的一致性，即"棵数=间隔数"，可以通过实物演示帮助理解。`;
                        break;
                }
            }
            
            reportText += "四、错误分析与教学建议\n";
            reportText += `1. 主要错误原因: ${mainErrorReason}\n`;
            reportText += `2. 教学建议: ${teachingSuggestion}\n`;
            
            // 创建并下载文件
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `植树问题分析报告_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('分析报告已成功导出', 'success');
        });
        
        // 教师端清空数据按钮
        document.getElementById('clearDataBtn').addEventListener('click', function() {
            if (confirm('确定要清空所有学生答题数据吗？此操作不可恢复！')) {
                // 清空数据
                studentRecords = [];
                localStorage.removeItem('plantingProblemRecords');
                
                // 更新仪表盘
                updateTeacherDashboard();
                
                showNotification('所有数据已成功清空', 'success');
            }
        });

        // 全屏切换功能
        function toggleFullScreen() {
            const btn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showNotification(`全屏切换错误: ${err.message}`, 'error');
                });
                btn.innerHTML = '<i class="fa fa-compress"></i>';
                showNotification('已进入全屏模式', 'info');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    btn.innerHTML = '<i class="fa fa-expand"></i>';
                    showNotification('已退出全屏模式', 'info');
                }
            }
        }
    </script>
</body>
</html>
