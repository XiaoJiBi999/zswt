<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学问题交互式教学工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .btn-hover {
                @apply hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200;
            }
            .page-transition {
                @apply transition-opacity duration-500;
            }
            .input-error {
                @apply border-red-500 focus:ring-red-500 focus:border-red-500;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-blue-50 font-sans min-h-screen overflow-x-hidden">
    <!-- 全屏切换按钮 -->
    <button id="fullscreenBtn" class="fixed top-4 right-4 z-50 bg-dark/80 text-white p-2 rounded-full hover:bg-dark transition-colors">
        <i class="fa fa-expand"></i>
    </button>

    <!-- 页面容器 -->
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- 页面标题 -->
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-center text-dark mb-8 py-4 bg-white/70 rounded-xl shadow-md">
            数学问题交互式教学工具
        </h1>

        <!-- 角色切换 -->
        <div class="text-center mb-8">
            <button id="studentBtn" class="px-6 py-3 bg-primary text-white rounded-lg btn-hover active">学生端</button>
            <button id="teacherBtn" class="px-6 py-3 bg-white text-dark rounded-lg btn-hover ml-4">教师端</button>
        </div>

        <!-- 教师密码验证（初始隐藏） -->
        <div id="teacherLogin" class="bg-white rounded-xl p-8 card-shadow hidden page-transition">
            <h2 class="text-2xl font-bold text-dark mb-6 text-center">教师端登录</h2>
            <div class="mb-6">
                <label for="teacherPassword" class="block text-neutral mb-2">教师密码</label>
                <input type="password" id="teacherPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
            </div>
            <button id="teacherLoginBtn" class="w-full py-3 bg-primary text-white rounded-lg btn-hover">登录</button>
        </div>

        <!-- 学生界面 -->
        <div id="studentInterface">
            <!-- 学生信息输入 -->
            <div id="studentHome" class="bg-white rounded-xl p-8 card-shadow page-transition">
                <h2 class="text-2xl font-bold text-dark mb-6 text-center">学生信息</h2>
                <div class="space-y-6">
                    <div>
                        <label for="studentName" class="block text-neutral mb-2">姓名</label>
                        <input type="text" id="studentName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="请输入姓名">
                    </div>
                    <div>
                        <label for="studentClass" class="block text-neutral mb-2">班级</label>
                        <select id="studentClass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <option value="">请选择班级</option>
                            <option value="五年1班">五年1班</option>
                            <option value="五年2班">五年2班</option>
                            <option value="五年3班">五年3班</option>
                            <option value="五年4班">五年4班</option>
                        </select>
                    </div>
                    <button id="startQuizBtn" class="w-full py-3 bg-primary text-white rounded-lg btn-hover text-lg mt-6">
                        开始答题 <i class="fa fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- 题目页面容器 -->
            <div id="questionPages" class="hidden page-transition">
                <!-- 题目导航 -->
                <div class="flex justify-center mb-8">
                    <div class="inline-flex bg-white p-1 rounded-lg shadow-sm">
                        <button class="question-nav-btn px-6 py-2 rounded-md border border-primary bg-primary text-white" data-question="1">1</button>
                        <button class="question-nav-btn px-6 py-2 rounded-md border border-gray-200" data-question="2">2</button>
                        <button class="question-nav-btn px-6 py-2 rounded-md border border-gray-200" data-question="3">3</button>
                        <button class="question-nav-btn px-6 py-2 rounded-md border border-gray-200" data-question="4">4</button>
                    </div>
                </div>

                <!-- 题目容器（由JS动态生成） -->
                <div id="dynamicQuestionsContainer"></div>

                <!-- 返回首页按钮 -->
                <div class="mt-10 text-center">
                    <button id="backToHomeBtn" class="px-6 py-3 bg-gray-200 text-dark rounded-lg btn-hover">
                        <i class="fa fa-home mr-2"></i> 返回首页
                    </button>
                </div>
            </div>

            <!-- 结果反馈区域 -->
            <div id="resultFeedback" class="mt-10 p-6 rounded-xl border border-orange-200 bg-orange-50 hidden page-transition opacity-0">
                <h2 id="feedbackTitle" class="text-2xl font-bold mb-6 text-center text-orange-600"></h2>
                <div id="feedbackContent" class="space-y-4"></div>
                
                <!-- 针对性练习 -->
                <div id="errorExercises" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-dark">针对性练习：</h3>
                    <div class="exercises-list grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                
                <!-- 再做一次按钮 -->
                <div class="mt-10 text-center">
                    <button id="tryAgainBtn" class="px-8 py-3 bg-primary text-white rounded-lg btn-hover">
                        <i class="fa fa-refresh mr-2"></i> 再做一次
                    </button>
                </div>
            </div>
        </div>

        <!-- 教师界面 -->
        <div id="teacherInterface" class="hidden page-transition">
            <div class="bg-white rounded-xl p-6 card-shadow mb-8">
                <h2 class="text-2xl font-bold text-dark mb-6">班级整体情况</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="p-5 rounded-xl bg-blue-50 border border-blue-100">
                        <div class="text-sm text-blue-600 mb-1">参与学生总数</div>
                        <div class="text-3xl font-bold text-blue-700" id="totalStudents">0</div>
                    </div>
                    <div class="p-5 rounded-xl bg-green-50 border border-green-100">
                        <div class="text-sm text-green-600 mb-1">全对人数</div>
                        <div class="text-3xl font-bold text-green-700" id="fullCorrectStudents">0</div>
                    </div>
                    <div class="p-5 rounded-xl bg-purple-50 border border-purple-100">
                        <div class="text-sm text-purple-600 mb-1">平均正确率</div>
                        <div class="text-3xl font-bold text-purple-700" id="averageAccuracy">0%</div>
                    </div>
                    <div class="p-5 rounded-xl bg-amber-50 border border-amber-100">
                        <div class="text-sm text-amber-600 mb-1">总答题次数</div>
                        <div class="text-3xl font-bold text-amber-700" id="totalAttempts">0</div>
                    </div>
                </div>
            </div>

            <!-- 各类型题目正确率热力图 -->
            <div class="mb-10">
                <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                    <i class="fa fa-thermometer-half mr-2 text-accent"></i>各类型题目正确率
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-5 rounded-xl text-center" id="heatBothEnds">
                        <div class="font-bold mb-3">两端都栽</div>
                        <div class="text-3xl" id="rateBothEnds">0%</div>
                    </div>
                    <div class="p-5 rounded-xl text-center" id="heatOneEnd">
                        <div class="font-bold mb-3">一端栽一端不栽</div>
                        <div class="text-3xl" id="rateOneEnd">0%</div>
                    </div>
                    <div class="p-5 rounded-xl text-center" id="heatNoEnd">
                        <div class="font-bold mb-3">两端都不栽</div>
                        <div class="text-3xl" id="rateNoEnd">0%</div>
                    </div>
                    <div class="p-5 rounded-xl text-center" id="heatCircle">
                        <div class="font-bold mb-3">封闭环形曲线</div>
                        <div class="text-3xl" id="rateCircle">0%</div>
                    </div>
                    <div class="p-5 rounded-xl text-center" id="heatCalculation">
                        <div class="font-bold mb-3">计算题</div>
                        <div class="text-3xl" id="rateCalculation">0%</div>
                    </div>
                    <div class="p-5 rounded-xl text-center" id="heatProblemSolving">
                        <div class="font-bold mb-3">解决问题</div>
                        <div class="text-3xl" id="rateProblemSolving">0%</div>
                    </div>
                </div>
            </div>

            <!-- 班级错题统计 -->
            <div class="mb-10">
                <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                    <i class="fa fa-bar-chart mr-2 text-primary"></i>班级错题分布
                </h3>
                <div class="overflow-x-auto bg-light/30 rounded-xl p-1">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-white">
                                <th class="px-6 py-4 border-b text-left">班级</th>
                                <th class="px-6 py-4 border-b text-left">总人数</th>
                                <th class="px-6 py-4 border-b text-left">全对人数</th>
                                <th class="px-6 py-4 border-b text-left">错误率最高类型</th>
                            </tr>
                        </thead>
                        <tbody id="classErrorStats">
                            <tr>
                                <td colspan="4" class="px-6 py-4 border-b text-center">暂无数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 错题分析报告 -->
            <div>
                <h3 class="text-xl font-semibold text-dark mb-5 flex items-center">
                    <i class="fa fa-file-text mr-2 text-accent"></i>错题分析报告
                </h3>
                <div id="errorReport" class="border border-gray-200 rounded-xl p-5 bg-light/30">
                    <p class="mb-3">1. 各类型题目错误率统计：</p>
                    <ul id="errorRateList" class="list-disc ml-6 mb-6 space-y-1">
                        <li>两端都栽：0%（0/0人错误）</li>
                        <li>一端栽一端不栽：0%（0/0人错误）</li>
                        <li>两端都不栽：0%（0/0人错误）</li>
                        <li>封闭环形曲线：0%（0/0人错误）</li>
                        <li>计算题：0%（0/0人错误）</li>
                        <li>解决问题：0%（0/0人错误）</li>
                    </ul>
                    <p class="mb-3">2. 主要错误原因：暂无数据</p>
                    <p class="mb-3">3. 教学建议：暂无数据</p>
                    <p class="text-sm text-neutral">数据更新时间：--</p>
                </div>
            </div>

            <!-- 导出按钮 -->
            <div class="mt-8 text-center">
                <button id="exportAnalysisBtn" class="px-6 py-3 bg-primary text-white rounded-lg btn-hover">
                    <i class="fa fa-download mr-2"></i> 导出分析报告
                </button>
                <button id="syncDataBtn" class="px-6 py-3 bg-accent text-white rounded-lg btn-hover ml-4">
                    <i class="fa fa-refresh mr-2"></i> 同步最新数据
                </button>
            </div>
        </div>
    </div>

    <!-- 音效资源 -->
    <audio id="clapSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>

    <!-- 通用题目表单模板 -->
    <template id="questionFormTemplate">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <label class="block text-neutral mb-2 text-lg">答案：</label>
                <input type="text" class="calculation-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="请输入计算过程和答案">
            </div>
        </div>
        
        <!-- 绘制按钮 -->
        <div class="mb-8">
            <button class="draw-diagram-btn px-4 py-2 bg-secondary text-white rounded-lg btn-hover text-sm">
                <i class="fa fa-paint-brush mr-1"></i> 绘制示意图（如需）
            </button>
        </div>
        
        <!-- 示意图画布 -->
        <div class="mb-8 hidden diagram-container">
            <canvas class="diagram-canvas border border-gray-200 rounded-lg bg-white"></canvas>
        </div>
    </template>

    <!-- 植树问题专用表单模板 -->
    <template id="plantingQuestionTemplate">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <label class="block text-neutral mb-2 text-lg">道路长度：（ ）米</label>
                <input type="number" class="road-length-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" min="1">
            </div>
            <div>
                <label class="block text-neutral mb-2 text-lg">两棵树之间的间隔距离：（ ）米</label>
                <input type="number" class="interval-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" min="1">
            </div>
        </div>
        
        <div class="mb-8">
            <label class="block text-neutral mb-3 text-lg">栽树方式：</label>
            <div class="space-y-2">
                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                    <input type="radio" name="plantType" value="bothEnds" class="mr-3">
                    <span>两端都栽</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                    <input type="radio" name="plantType" value="oneEnd" class="mr-3">
                    <span>一端栽，另一端不栽（如靠墙）</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                    <input type="radio" name="plantType" value="noEnd" class="mr-3">
                    <span>两端都不栽</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-light cursor-pointer">
                    <input type="radio" name="plantType" value="circle" class="mr-3">
                    <span>封闭环形（如圆形池塘周围）</span>
                </label>
            </div>
        </div>
        
        <div class="mb-8">
            <label class="block text-neutral mb-2 text-lg">计算过程和答案：</label>
            <input type="text" class="calculation-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="例如：30÷5=6段，6+1=7棵">
        </div>
        
        <!-- 绘制按钮 -->
        <div class="mb-8">
            <button class="draw-diagram-btn px-4 py-2 bg-secondary text-white rounded-lg btn-hover text-sm">
                <i class="fa fa-paint-brush mr-1"></i> 绘制示意图
            </button>
        </div>
        
        <!-- 示意图画布 -->
        <div class="mb-8 hidden diagram-container">
            <canvas class="diagram-canvas border border-gray-200 rounded-lg bg-white" width="600" height="200"></canvas>
        </div>
    </template>

    <script>
        // 全局配置 - GitHub API 相关
        const GITHUB_CONFIG = {
            owner: 'XiaoJiBi999',  // 替换为你的GitHub用户名
            repo: 'zswt',          // 替换为你的仓库名
            path: 'temp.json',   // 存储记录的文件名
            branch: 'main',                 // 分支名
            token: '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'
        };

        // 全局数据存储
        let questionBank = {};             // 题库
        let studentRecords = [];           // 学生答题记录
        let currentQuestion = 1;           // 当前题目
        let studentInfo = { name: '', className: '' }; // 学生信息
        let startTime = null;              // 答题开始时间
        let selectedQuestions = [];        // 随机选中的题目
        let questionData = {};             // 存储各题目的答题数据

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 从localStorage加载数据
            loadLocalData();
            
            // 加载题库
            loadQuestionBank();
            
            // 初始化事件监听
            initEventListeners();
            
            // 检查是否已登录教师端
            if (localStorage.getItem('teacherLoggedIn') === 'true') {
                switchToTeacherInterface();
            }
        });

        // 加载题库
        async function loadQuestionBank() {
            try {
                // 尝试从GitHub加载题库
                const githubResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/questions.json`);
                
                if (githubResponse.ok) {
                    questionBank = await githubResponse.json();
                } else {
                    // 如果GitHub加载失败，尝试从本地加载
                    const localResponse = await fetch('questions.json');
                    questionBank = await localResponse.json();
                }
                
                console.log('题库加载成功，题目数量：', 
                    `植树问题: ${questionBank.planting?.length || 0}, ` +
                    `计算题: ${questionBank.calculation?.length || 0}, ` +
                    `解决问题: ${questionBank.problemSolving?.length || 0}`);
            } catch (error) {
                console.error('加载题库失败:', error);
                showNotification('题库加载失败，请刷新页面重试', 'error');
                
                // 使用默认题目作为备选
                questionBank = getDefaultQuestions();
            }
        }

        // 生成默认题目（当题库加载失败时使用）
        function getDefaultQuestions() {
            return {
                planting: [
                    {
                        id: 1,
                        type: "bothEnds",
                        question: "一条30米长的小路，每隔5米栽一棵树（两端都栽），共需栽多少棵树？",
                        correctLength: 30,
                        correctInterval: 5,
                        correctCount: 7
                    },
                    {
                        id: 2,
                        type: "oneEnd",
                        question: "一条35米长的小路，绿化队要在小路一旁栽一排树，每隔7米栽一棵树，一端靠墙。一共要栽多少棵树？",
                        correctLength: 35,
                        correctInterval: 7,
                        correctCount: 5
                    }
                ],
                calculation: [
                    {
                        id: 101,
                        question: "计算：125 × 88 + 360 ÷ 12",
                        correctAnswer: 11030,
                        hint: "可以使用乘法分配律简化计算"
                    },
                    {
                        id: 102,
                        question: "计算：99 × 38 + 38",
                        correctAnswer: 3800,
                        hint: "可以使用乘法分配律的逆运算"
                    }
                ],
                problemSolving: [
                    {
                        id: 201,
                        question: "小明买了3支钢笔和5本笔记本，共花了48元。已知每支钢笔8元，每本笔记本多少元？",
                        correctAnswer: 4.8,
                        unit: "元"
                    },
                    {
                        id: 202,
                        question: "学校图书馆买来一批新书，其中故事书有240本，是科技书的3倍，科技书有多少本？",
                        correctAnswer: 80,
                        unit: "本"
                    }
                ]
            };
        }

        // 随机选择4道题（各类别均衡）
        function selectRandomQuestions() {
            if (Object.keys(questionBank).length === 0) {
                showNotification('题库尚未加载完成，请稍候', 'info');
                return [];
            }
            
            const questions = [];
            const categories = Object.keys(questionBank);
            
            // 确保至少从每个类别选择一道题
            if (categories.length >= 3) {
                questions.push(...getRandomFromCategory('planting', 1));
                questions.push(...getRandomFromCategory('calculation', 1));
                questions.push(...getRandomFromCategory('problemSolving', 1));
                
                // 从所有类别中随机选择最后一道题
                const allQuestions = [];
                categories.forEach(category => {
                    allQuestions.push(...questionBank[category].map(q => ({...q, category})));
                });
                questions.push(shuffleArray(allQuestions)[0]);
            } else {
                // 如果类别不足3个，随机选择
                categories.forEach((category, index) => {
                    const count = index < 3 ? 1 : 0;
                    questions.push(...getRandomFromCategory(category, count));
                });
                // 补足4题
                while (questions.length < 4) {
                    const randomCat = categories[Math.floor(Math.random() * categories.length)];
                    questions.push(...getRandomFromCategory(randomCat, 1));
                }
            }
            
            // 打乱顺序并添加题号
            return shuffleArray(questions).map((q, index) => ({
                ...q,
                questionNum: index + 1
            }));
        }

        // 从指定类别随机选择n道题
        function getRandomFromCategory(category, n) {
            if (!questionBank[category] || questionBank[category].length === 0) {
                return [];
            }
            const shuffled = shuffleArray([...questionBank[category]]);
            return shuffled.slice(0, n).map(q => ({...q, category}));
        }

        // 生成题目页面
        function generateQuestionPages() {
            const container = document.getElementById('dynamicQuestionsContainer');
            container.innerHTML = '';
            
            selectedQuestions.forEach((question, index) => {
                const questionPage = document.createElement('div');
                questionPage.className = `question-page ${index === 0 ? '' : 'hidden'}`;
                questionPage.dataset.question = question.questionNum;
                questionPage.dataset.category = question.category;
                questionPage.dataset.id = question.id;
                
                // 设置题目数据属性
                Object.keys(question).forEach(key => {
                    if (key !== 'question' && key !== 'category' && key !== 'questionNum') {
                        questionPage.dataset[key] = question[key];
                    }
                });
                
                // 题目内容
                let formTemplate;
                let navigationHtml = '';
                
                // 根据题目类型选择不同的表单模板
                if (question.category === 'planting') {
                    formTemplate = document.getElementById('plantingQuestionTemplate').innerHTML;
                } else {
                    formTemplate = document.getElementById('questionFormTemplate').innerHTML;
                }
                
                // 生成导航按钮
                if (question.questionNum < 4) {
                    navigationHtml = `
                        <div class="mt-10 text-center">
                            <button class="next-question-btn px-8 py-4 bg-primary text-white rounded-lg btn-hover text-lg" data-next="${question.questionNum + 1}">
                                下一题 <i class="fa fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    `;
                } else {
                    navigationHtml = `
                        <div class="mt-10 text-center">
                            <button id="checkAllBtn" class="px-8 py-4 bg-accent text-white rounded-lg btn-hover text-lg">
                                <i class="fa fa-check-circle mr-2"></i> 检验所有结果
                            </button>
                        </div>
                    `;
                }
                
                // 组装题目页面
                questionPage.innerHTML = `
                    <div class="bg-light p-5 rounded-lg mb-6 border-l-4 border-primary">
                        <p class="text-lg md:text-xl">第${question.questionNum}题：${question.question}</p>
                        ${question.hint ? `<p class="text-sm text-gray-600 mt-2"><i class="fa fa-lightbulb-o mr-1"></i> 提示：${question.hint}</p>` : ''}
                    </div>
                    <div class="question-form"></div>
                    ${navigationHtml}
                `;
                
                container.appendChild(questionPage);
                
                // 填充表单模板
                const formContainer = questionPage.querySelector('.question-form');
                formContainer.innerHTML = formTemplate;
            });
            
            // 初始化题目数据存储
            questionData = {};
            for (let i = 1; i <= 4; i++) {
                questionData[i] = {
                    roadLength: '',
                    interval: '',
                    plantType: '',
                    calculation: ''
                };
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            // 全屏切换功能
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullScreen);
            
            // 角色切换功能
            document.getElementById('studentBtn').addEventListener('click', () => {
                switchToStudentInterface();
            });
            
            document.getElementById('teacherBtn').addEventListener('click', () => {
                document.getElementById('teacherLogin').classList.remove('hidden');
                document.getElementById('studentInterface').classList.add('hidden');
                document.getElementById('teacherInterface').classList.add('hidden');
            });
            
            // 教师登录
            document.getElementById('teacherLoginBtn').addEventListener('click', () => {
                const password = document.getElementById('teacherPassword').value;
                // 实际应用中应使用更安全的验证方式
                if (password === 'teacher123') { // 临时密码，实际应用需修改
                    localStorage.setItem('teacherLoggedIn', 'true');
                    switchToTeacherInterface();
                    document.getElementById('teacherPassword').value = '';
                } else {
                    showNotification('密码错误', 'error');
                    shakeElement(document.getElementById('teacherPassword'));
                }
            });
            
            // 开始答题
            document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
            
            // 返回首页
            document.getElementById('backToHomeBtn').addEventListener('click', () => {
                document.getElementById('questionPages').classList.add('hidden');
                document.getElementById('studentHome').classList.remove('hidden');
            });
            
            // 再做一次
            document.getElementById('tryAgainBtn').addEventListener('click', () => {
                document.getElementById('resultFeedback').classList.add('hidden', 'opacity-0');
                startQuiz();
            });
            
            // 下一题按钮
            document.addEventListener('click', (e) => {
                if (e.target.closest('.next-question-btn')) {
                    const btn = e.target.closest('.next-question-btn');
                    const nextNum = parseInt(btn.dataset.next);
                    saveCurrentQuestionData();
                    switchQuestion(nextNum);
                }
            });
            
            // 题目导航按钮
            document.addEventListener('click', (e) => {
                if (e.target.closest('.question-nav-btn') && !e.target.closest('.question-nav-btn').classList.contains('bg-primary')) {
                    const btn = e.target.closest('.question-nav-btn');
                    const questionNum = parseInt(btn.dataset.question);
                    saveCurrentQuestionData();
                    switchQuestion(questionNum);
                }
            });
            
            // 检验结果
            document.addEventListener('click', (e) => {
                if (e.target.closest('#checkAllBtn')) {
                    saveCurrentQuestionData();
                    checkAllAnswers();
                }
            });
            
            // 绘制示意图按钮
            document.addEventListener('click', (e) => {
                if (e.target.closest('.draw-diagram-btn')) {
                    const btn = e.target.closest('.draw-diagram-btn');
                    const container = btn.nextElementSibling;
                    const canvas = container.querySelector('.diagram-canvas');
                    
                    // 切换显示状态
                    container.classList.toggle('hidden');
                    
                    // 如果是植树问题，绘制示意图
                    const questionPage = btn.closest('.question-page');
                    if (questionPage.dataset.category === 'planting' && !container.classList.contains('hidden')) {
                        const roadLength = parseInt(questionPage.querySelector('.road-length-input').value) || 30;
                        const interval = parseInt(questionPage.querySelector('.interval-input').value) || 5;
                        const plantType = questionPage.querySelector('input[name="plantType"]:checked')?.value || 'bothEnds';
                        
                        // 根据植树类型绘制不同的示意图
                        if (plantType === 'circle') {
                            drawCircle(canvas, roadLength, interval);
                        } else {
                            const startPlant = plantType === 'bothEnds' || plantType === 'oneEnd';
                            const endPlant = plantType === 'bothEnds';
                            drawLinear(canvas, roadLength, interval, startPlant, endPlant);
                        }
                    }
                }
            });
            
            // 导出分析报告
            document.getElementById('exportAnalysisBtn').addEventListener('click', exportAnalysisReport);
            
            // 同步数据
            document.getElementById('syncDataBtn').addEventListener('click', syncData);
        }

        // 开始答题
        function startQuiz() {
            const name = document.getElementById('studentName').value.trim();
            const className = document.getElementById('studentClass').value;
            
            if (!name || !className) {
                showNotification('请填写完整的姓名和班级信息', 'error');
                return;
            }
            
            // 保存学生信息
            studentInfo = { name, className };
            
            // 随机选择题目
            selectedQuestions = selectRandomQuestions();
            if (selectedQuestions.length < 4) {
                showNotification('题目加载不足，无法开始答题', 'error');
                return;
            }
            
            // 生成题目页面
            generateQuestionPages();
            
            // 记录开始时间
            startTime = new Date();
            
            // 显示题目页面
            document.getElementById('studentHome').classList.add('hidden');
            document.getElementById('questionPages').classList.remove('hidden');
            
            // 重置当前题目
            currentQuestion = 1;
            updateQuestionNavStyles(1);
        }

        // 切换题目
        function switchQuestion(questionNum) {
            // 隐藏当前题目
            document.querySelector(`.question-page[data-question="${currentQuestion}"]`).classList.add('hidden');
            
            // 显示新题目
            document.querySelector(`.question-page[data-question="${questionNum}"]`).classList.remove('hidden');
            
            // 加载题目数据
            loadQuestionData(questionNum);
            
            // 更新当前题目
            currentQuestion = questionNum;
            updateQuestionNavStyles(questionNum);
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 更新题目导航样式
        function updateQuestionNavStyles(activeNum) {
            document.querySelectorAll('.question-nav-btn').forEach(btn => {
                const btnNum = parseInt(btn.dataset.question);
                if (btnNum === activeNum) {
                    btn.classList.add('bg-primary', 'text-white', 'border-primary');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-200');
                }
            });
        }

        // 保存当前题目的数据
        function saveCurrentQuestionData() {
            const questionPage = document.querySelector(`.question-page[data-question="${currentQuestion}"]`);
            const category = questionPage.dataset.category;
            
            const data = {
                calculation: questionPage.querySelector('.calculation-input').value
            };
            
            // 如果是植树问题，保存额外数据
            if (category === 'planting') {
                data.roadLength = questionPage.querySelector('.road-length-input').value;
                data.interval = questionPage.querySelector('.interval-input').value;
                data.plantType = questionPage.querySelector('input[name="plantType"]:checked')?.value || '';
            }
            
            questionData[currentQuestion] = data;
        }

        // 加载指定题目的数据
        function loadQuestionData(questionNum) {
            const questionPage = document.querySelector(`.question-page[data-question="${questionNum}"]`);
            const data = questionData[questionNum];
            const category = questionPage.dataset.category;
            
            questionPage.querySelector('.calculation-input').value = data.calculation;
            
            // 如果是植树问题，加载额外数据
            if (category === 'planting') {
                questionPage.querySelector('.road-length-input').value = data.roadLength;
                questionPage.querySelector('.interval-input').value = data.interval;
                
                // 清除所有选中状态
                questionPage.querySelectorAll('input[name="plantType"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // 设置选中状态
                if (data.plantType) {
                    const radio = questionPage.querySelector(`input[name="plantType"][value="${data.plantType}"]`);
                    if (radio) radio.checked = true;
                }
            }
        }

        // 检验所有答案
        function checkAllAnswers() {
            // 检查是否完成所有题目
            const incompleteQuestions = [];
            let allCompleted = true;
            
            for (let i = 1; i <= 4; i++) {
                const data = questionData[i];
                const questionPage = document.querySelector(`.question-page[data-question="${i}"]`);
                const category = questionPage.dataset.category;
                
                // 检查是否完成答题
                if (!data.calculation) {
                    allCompleted = false;
                    incompleteQuestions.push(i);
                } else if (category === 'planting') {
                    // 植树问题需要额外检查
                    if (!data.roadLength || !data.interval || !data.plantType) {
                        allCompleted = false;
                        incompleteQuestions.push(i);
                    }
                }
            }
            
            // 未完成所有题目
            if (!allCompleted) {
                showNotification(`以下题目未完成：第${incompleteQuestions.join('、')}题，请先完成后再检验！`, 'error');
                
                // 高亮显示未完成的题目导航
                document.querySelectorAll('.question-nav-btn').forEach(btn => {
                    const btnNum = parseInt(btn.getAttribute('data-question'));
                    if (incompleteQuestions.includes(btnNum)) {
                        btn.classList.add('border-red-500', 'text-red-500', 'animate-pulse');
                        // 3秒后移除动画
                        setTimeout(() => {
                            btn.classList.remove('animate-pulse');
                        }, 3000);
                    }
                });
                
                return;
            }
            
            // 收集所有题目数据
            const allQuestionsData = [];
            for (let i = 1; i <= 4; i++) {
                const questionPage = document.querySelector(`.question-page[data-question="${i}"]`);
                const data = {
                    ...questionData[i],
                    questionNum: i,
                    question: questionPage.querySelector('p').textContent,
                    category: questionPage.dataset.category,
                    correctAnswer: questionPage.dataset.correctAnswer || questionPage.dataset.correctCount,
                    correctType: questionPage.dataset.type,
                    correctLength: questionPage.dataset.correctLength ? parseInt(questionPage.dataset.correctLength) : null,
                    correctInterval: questionPage.dataset.correctInterval ? parseInt(questionPage.dataset.correctInterval) : null,
                    correctCount: questionPage.dataset.correctCount ? parseInt(questionPage.dataset.correctCount) : null
                };
                
                allQuestionsData.push(data);
            }
            
            // 分析答案
            const analysisResult = analyzeAnswers(allQuestionsData);
            
            // 记录答题时间
            const endTime = new Date();
            const duration = Math.round((endTime - startTime) / 1000); // 秒
            
            // 保存记录
            const record = {
                studentInfo: { ...studentInfo },
                timestamp: new Date().toISOString(),
                duration,
                result: analysisResult,
                questions: selectedQuestions
            };
            
            studentRecords.push(record);
            
            // 保存到本地和云端
            saveLocalData();
            syncData(true);
            
            // 显示结果反馈
            showResultFeedback(analysisResult);
        }

        // 分析答题结果
        function analyzeAnswers(questionsData) {
            const result = {
                totalCorrect: 0,
                questionResults: [],
                allCorrect: false,
                errorPatterns: [],
                mainErrorType: null
            };

            // 分析每个题目的答案
            questionsData.forEach(question => {
                const questionResult = {
                    questionNum: question.questionNum,
                    correct: false,
                    errorReasons: [],
                    category: question.category
                };
                
                // 根据题目类型进行不同的验证
                if (question.category === 'planting') {
                    // 验证植树问题
                    analyzePlantingQuestion(question, questionResult);
                } else if (question.category === 'calculation') {
                    // 验证计算题
                    analyzeCalculationQuestion(question, questionResult);
                } else if (question.category === 'problemSolving') {
                    // 验证解决问题
                    analyzeProblemSolvingQuestion(question, questionResult);
                }
                
                if (questionResult.correct) {
                    result.totalCorrect++;
                }
                
                result.questionResults.push(questionResult);
            });

            // 分析错误模式
            analyzeErrorPatterns(result);

            // 判断是否全对
            result.allCorrect = result.totalCorrect === 4;

            return result;
        }

        // 分析植树问题答案
        function analyzePlantingQuestion(question, result) {
            result.correctType = question.correctType;
            
            // 验证道路长度和间隔
            const lengthCorrect = parseInt(question.roadLength) === question.correctLength;
            const intervalCorrect = parseInt(question.interval) === question.correctInterval;
            const typeCorrect = question.plantType === question.correctType;
            
            // 提取学生答案中的数字
            const studentResultMatch = question.calculation.match(/(\d+)(?=\（棵\）|棵|株|个|朵)/);
            const studentResult = studentResultMatch ? parseInt(studentResultMatch[1]) : null;
            const countCorrect = studentResult === question.correctCount;
            
            // 提取使用的公式类型
            let formulaType = null;
            if (question.calculation.includes('+1')) formulaType = 'add1';
            else if (question.calculation.includes('-1')) formulaType = 'subtract1';
            else if (question.calculation.includes('÷') || question.calculation.includes('/')) formulaType = 'divideOnly';
            
            result.formulaType = formulaType;
            result.correctFormulaType = getCorrectFormulaType(question.correctType);
            
            // 错误原因分析
            if (!lengthCorrect) {
                result.errorReasons.push(`道路长度错误，应为${question.correctLength}米`);
            }
            
            if (!intervalCorrect) {
                result.errorReasons.push(`间隔距离错误，应为${question.correctInterval}米`);
            }
            
            if (!typeCorrect) {
                result.errorReasons.push(`栽树类型判断错误，应为${getPlantTypeName(question.correctType)}`);
            }
            
            if (studentResult === null) {
                result.errorReasons.push('未提供有效答案');
            } else if (!countCorrect) {
                result.errorReasons.push(`答案错误，正确答案应为${question.correctCount}棵`);
            }
            
            // 判断是否正确
            result.correct = lengthCorrect && intervalCorrect && typeCorrect && countCorrect;
            result.correctCount = question.correctCount;
            result.studentResult = studentResult;
        }

        // 分析计算题答案
        function analyzeCalculationQuestion(question, result) {
            // 提取学生答案中的数字
            const studentResultMatch = question.calculation.match(/(\d+(\.\d+)?)/g);
            const studentResult = studentResultMatch ? parseFloat(studentResultMatch[studentResultMatch.length - 1]) : null;
            const correctAnswer = parseFloat(question.correctAnswer);
            
            // 判断是否正确（考虑浮点数精度问题）
            const countCorrect = studentResult !== null && Math.abs(studentResult - correctAnswer) < 0.001;
            
            // 错误原因分析
            if (studentResult === null) {
                result.errorReasons.push('未提供有效答案');
            } else if (!countCorrect) {
                result.errorReasons.push(`答案错误，正确答案应为${correctAnswer}`);
            }
            
            result.correct = countCorrect;
            result.correctAnswer = correctAnswer;
            result.studentResult = studentResult;
        }

        // 分析解决问题答案
        function analyzeProblemSolvingQuestion(question, result) {
            // 提取学生答案中的数字
            const studentResultMatch = question.calculation.match(/(\d+(\.\d+)?)/g);
            const studentResult = studentResultMatch ? parseFloat(studentResultMatch[studentResultMatch.length - 1]) : null;
            const correctAnswer = parseFloat(question.correctAnswer);
            
            // 判断是否正确（考虑浮点数精度问题）
            const countCorrect = studentResult !== null && Math.abs(studentResult - correctAnswer) < 0.001;
            
            // 错误原因分析
            if (studentResult === null) {
                result.errorReasons.push('未提供有效答案');
            } else if (!countCorrect) {
                const unit = question.unit || '';
                result.errorReasons.push(`答案错误，正确答案应为${correctAnswer}${unit}`);
            }
            
            result.correct = countCorrect;
            result.correctAnswer = correctAnswer;
            result.studentResult = studentResult;
            result.unit = question.unit;
        }

        // 获取正确的公式类型
        function getCorrectFormulaType(plantType) {
            switch (plantType) {
                case 'bothEnds': return 'add1'; // 间隔数+1
                case 'oneEnd': return 'divideOnly'; // 间隔数
                case 'noEnd': return 'subtract1'; // 间隔数-1
                case 'circle': return 'divideOnly'; // 间隔数（与一端栽相同）
            }
        }

        // 分析错误模式
        function analyzeErrorPatterns(result) {
            // 分离不同类型的题目错误
            const plantingQuestions = result.questionResults.filter(q => q.category === 'planting');
            const calculationQuestions = result.questionResults.filter(q => q.category === 'calculation');
            const problemQuestions = result.questionResults.filter(q => q.category === 'problemSolving');
            
            // 分析植树问题错误模式
            if (plantingQuestions.length > 0) {
                analyzePlantingErrorPatterns(plantingQuestions, result);
            }
            
            // 分析计算题错误模式
            if (calculationQuestions.length > 0 && calculationQuestions.filter(q => !q.correct).length > 0) {
                result.errorPatterns.push('计算题存在计算错误，建议加强基本运算练习');
            }
            
            // 分析解决问题错误模式
            if (problemQuestions.length > 0 && problemQuestions.filter(q => !q.correct).length > 0) {
                result.errorPatterns.push('解决问题能力有待提高，建议加强题意理解和建模训练');
            }
            
            // 确定主要错误类型
            const errorTypeCount = {};
            result.questionResults.forEach(q => {
                if (!q.correct) {
                    const type = q.category === 'planting' ? q.correctType : q.category;
                    errorTypeCount[type] = (errorTypeCount[type] || 0) + 1;
                }
            });
            
            if (Object.keys(errorTypeCount).length > 0) {
                result.mainErrorType = Object.entries(errorTypeCount).sort((a, b) => b[1] - a[1])[0][0];
            }
        }

        // 分析植树问题错误模式
        function analyzePlantingErrorPatterns(questions, result) {
            // 1. 检查是否混淆了两端栽和一端栽的模型
            const bothEndsQuestion = questions.find(q => q.correctType === 'bothEnds');
            const oneEndQuestion = questions.find(q => q.correctType === 'oneEnd');
            
            if (bothEndsQuestion && !bothEndsQuestion.correct && 
                oneEndQuestion && !oneEndQuestion.correct &&
                bothEndsQuestion.formulaType === 'divideOnly' && 
                oneEndQuestion.formulaType === 'divideOnly') {
                result.errorPatterns.push('无法区分"两端栽树"与"一端栽一端不栽"模型的不同，都使用了相同的公式（仅用间隔数）进行计算');
            }
            
            // 2. 检查是否所有题目都使用了相同的公式
            const formulaTypes = new Set();
            questions.forEach(q => {
                if (q.formulaType) formulaTypes.add(q.formulaType);
            });
            
            if (formulaTypes.size === 1 && questions.filter(q => !q.correct).length > 0) {
                result.errorPatterns.push('对所有类型的题目都使用了相同的计算公式，没有根据实际情况调整');
            }
            
            // 3. 检查是否混淆了封闭环形与其他类型
            const circleQuestion = questions.find(q => q.correctType === 'circle');
            if (circleQuestion && !circleQuestion.correct) {
                if (circleQuestion.formulaType === 'add1') {
                    result.errorPatterns.push('将封闭环形栽树错误地按照"两端都栽"的公式计算（间隔数+1）');
                } else if (circleQuestion.formulaType === 'subtract1') {
                    result.errorPatterns.push('将封闭环形栽树错误地按照"两端都不栽"的公式计算（间隔数-1）');
                }
            }
            
            // 4. 检查是否对"两端都不栽"的理解有误
            const noEndQuestion = questions.find(q => q.correctType === 'noEnd');
            if (noEndQuestion && !noEndQuestion.correct && noEndQuestion.formulaType !== 'subtract1') {
                result.errorPatterns.push('对"两端都不栽"的模型理解有误，未使用正确的公式（间隔数-1）');
            }
        }

        // 显示结果反馈
        function showResultFeedback(analysisResult) {
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackContent = document.getElementById('feedbackContent');
            const resultFeedback = document.getElementById('resultFeedback');
            const errorExercises = document.getElementById('errorExercises');
            const exercisesList = document.querySelector('.exercises-list');

            // 清空之前的内容
            feedbackContent.innerHTML = '';
            exercisesList.innerHTML = '';

            if (analysisResult.allCorrect) {
                // 全对
                resultFeedback.className = 'mt-10 p-6 rounded-xl border border-green-200 bg-green-50 hidden page-transition';
                feedbackTitle.textContent = '恭喜你！所有题目都答对了！';
                feedbackTitle.className = 'text-2xl font-bold mb-6 text-center text-green-600';
                feedbackContent.innerHTML = `
                    <p class="text-center mb-6">你表现得非常出色，继续加油！</p>
                    <div class="text-center bg-white p-4 rounded-lg inline-block mx-auto">
                        <p class="text-neutral">答题总时长：${Math.floor(analysisResult.duration / 60)}分${analysisResult.duration % 60}秒</p>
                    </div>
                `;
                errorExercises.classList.add('hidden');
                
                // 播放音效和散花
                document.getElementById('clapSound').play().catch(e => console.log('音效播放失败:', e));
                createConfetti();
            } else {
                // 有错
                resultFeedback.className = 'mt-10 p-6 rounded-xl border border-orange-200 bg-orange-50 hidden page-transition';
                feedbackTitle.textContent = `共完成4题，正确${analysisResult.totalCorrect}题，错误${4 - analysisResult.totalCorrect}题`;
                feedbackTitle.className = 'text-2xl font-bold mb-6 text-center text-orange-600';
                
                // 生成错误题目列表
                const errorList = document.createElement('ul');
                errorList.className = 'list-disc ml-6 space-y-4';
                
                analysisResult.questionResults.forEach(question => {
                    if (!question.correct) {
                        const li = document.createElement('li');
                        li.className = 'p-3 border-l-4 border-red-300 bg-white rounded-r-lg';
                        
                        let correctSolution = '';
                        if (question.category === 'planting') {
                            correctSolution = getCorrectFormula(question);
                        } else if (question.category === 'calculation') {
                            correctSolution = `正确答案：${question.correctAnswer}`;
                        } else if (question.category === 'problemSolving') {
                            const unit = question.unit || '';
                            correctSolution = `正确答案：${question.correctAnswer}${unit}`;
                        }
                        
                        li.innerHTML = `
                            <strong>第${question.questionNum}题（${getQuestionTypeName(question)}）：</strong>
                            <ul class="list-circle ml-6 mt-2 text-sm space-y-1">
                                ${question.errorReasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                            <div class="mt-2 text-sm text-green-600">正确解法：${correctSolution}</div>
                        `;
                        errorList.appendChild(li);
                    }
                });
                
                feedbackContent.appendChild(errorList);
                
                // 生成综合错误模式分析
                if (analysisResult.errorPatterns.length > 0) {
                    const patternAnalysis = document.createElement('div');
                    patternAnalysis.className = 'mt-6 p-4 bg-white rounded-lg';
                    patternAnalysis.innerHTML = `
                        <p class="font-medium mb-3">综合错误分析：</p>
                        <ul class="list-disc ml-6 text-sm space-y-2">
                            ${analysisResult.errorPatterns.map(pattern => `<li>${pattern}</li>`).join('')}
                        </ul>
                    `;
                    feedbackContent.appendChild(patternAnalysis);
                }
                
                // 生成改进建议
                const improvementTips = document.createElement('div');
                improvementTips.className = 'mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100';
                
                if (analysisResult.mainErrorType) {
                    improvementTips.innerHTML = `
                        <p class="font-medium mb-2">改进建议：</p>
                        <p class="text-sm">1. 重点理解<strong>${getQuestionTypeName({category: getCategoryFromType(analysisResult.mainErrorType), correctType: analysisResult.mainErrorType})}</strong>类型的特点和计算方法</p>
                        ${analysisResult.mainErrorType.includes('bothEnds') || 
                          analysisResult.mainErrorType.includes('oneEnd') ||
                          analysisResult.mainErrorType.includes('noEnd') ||
                          analysisResult.mainErrorType.includes('circle') ? 
                          `<p class="text-sm mt-1">2. 记住不同类型的核心区别：</p>
                        <ul class="list-disc ml-6 text-sm mt-1 space-y-1">
                            <li>两端都栽：棵数 = 间隔数 + 1</li>
                            <li>一端栽一端不栽：棵数 = 间隔数</li>
                            <li>两端都不栽：棵数 = 间隔数 - 1</li>
                            <li>封闭环形：棵数 = 间隔数（与一端栽相同）</li>
                        </ul>` : ''}
                        <p class="text-sm mt-2">3. 多做相关练习，加深理解和掌握</p>
                    `;
                } else {
                    improvementTips.innerHTML = `
                        <p class="font-medium mb-2">改进建议：</p>
                        <p class="text-sm">1. 加强对各类题型的理解和区分</p>
                        <p class="text-sm mt-1">2. 多做对比练习，掌握不同类型的解题方法</p>
                    `;
                }
                
                feedbackContent.appendChild(improvementTips);
                
                // 生成针对性练习
                generateExercises(analysisResult.mainErrorType || 'bothEnds', exercisesList);
                errorExercises.classList.remove('hidden');
            }

            // 显示反馈，添加动画
            resultFeedback.classList.remove('hidden');
            setTimeout(() => {
                resultFeedback.classList.remove('opacity-0');
            }, 50);
            
            // 滚动到反馈区域
            resultFeedback.scrollIntoView({ behavior: 'smooth' });
        }

        // 获取题目类型名称
        function getQuestionTypeName(question) {
            if (question.category === 'planting') {
                return getPlantTypeName(question.correctType);
            } else if (question.category === 'calculation') {
                return '计算题';
            } else if (question.category === 'problemSolving') {
                return '解决问题';
            }
            return '';
        }

        // 从错误类型获取类别
        function getCategoryFromType(errorType) {
            if (['bothEnds', 'oneEnd', 'noEnd', 'circle'].includes(errorType)) {
                return 'planting';
            }
            return errorType;
        }

        // 获取植树类型名称
        function getPlantTypeName(plantType) {
            switch (plantType) {
                case 'bothEnds': return '两端都栽';
                case 'oneEnd': return '一端栽一端不栽';
                case 'noEnd': return '两端都不栽';
                case 'circle': return '封闭环形栽树';
            }
        }

        // 获取正确的公式描述
        function getCorrectFormula(question) {
            const length = question.correctLength;
            const interval = question.correctInterval;
            const count = question.correctCount;
            const segments = length / interval;
            
            switch (question.correctType) {
                case 'bothEnds':
                    return `${length} ÷ ${interval} = ${segments}（间隔），${segments} + 1 = ${count}（棵）（两端都栽需加1）`;
                case 'oneEnd':
                    return `${length} ÷ ${interval} = ${segments}（间隔），棵数 = 间隔数 = ${count}（棵）（一端栽无需加减）`;
                case 'noEnd':
                    return `${length} ÷ ${interval} = ${segments}（间隔），${segments} - 1 = ${count}（棵）（两端都不栽需减1）`;
                case 'circle':
                    return `${length} ÷ ${interval} = ${segments}（间隔），棵数 = 间隔数 = ${count}（朵）（环形栽树与一端栽相同）`;
            }
        }

        // 生成针对性练习
        function generateExercises(mainType, container) {
            const category = getCategoryFromType(mainType);
            
            // 根据主要错误类型生成相应的练习
            if (category === 'planting') {
                generatePlantingExercises(mainType, container);
            } else if (category === 'calculation') {
                generateCalculationExercises(container);
            } else if (category === 'problemSolving') {
                generateProblemSolvingExercises(container);
            }
        }

        // 生成植树问题练习
        function generatePlantingExercises(mainType, container) {
            // 练习类型分布：主要错误类型2题，其他类型1题
            const exerciseTypes = [mainType, mainType];
            const otherTypes = ['bothEnds', 'oneEnd', 'noEnd', 'circle'].filter(type => type !== mainType);
            exerciseTypes.push(otherTypes[Math.floor(Math.random() * otherTypes.length)]);

            // 生成练习
            exerciseTypes.forEach((type, index) => {
                const interval = Math.floor(Math.random() * 5) + 3; // 3-7米
                const segmentCount = Math.floor(Math.random() * 7) + 4; // 4-10段
                const roadLength = interval * segmentCount;
                
                let correctAnswer, formulaSuffix, formulaDesc;

                // 计算正确答案和公式描述
                switch (type) {
                    case 'bothEnds':
                        correctAnswer = segmentCount + 1;
                        formulaSuffix = '+ 1';
                        formulaDesc = '（两端都栽：间隔数+1）';
                        break;
                    case 'oneEnd':
                        correctAnswer = segmentCount;
                        formulaSuffix = '';
                        formulaDesc = '（一端栽：间隔数）';
                        break;
                    case 'noEnd':
                        correctAnswer = segmentCount - 1;
                        formulaSuffix = '- 1';
                        formulaDesc = '（两端都不栽：间隔数-1）';
                        break;
                    case 'circle':
                        correctAnswer = segmentCount;
                        formulaSuffix = '';
                        formulaDesc = '（环形：间隔数）';
                        break;
                }

                // 创建练习项
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'p-4 border border-gray-200 rounded-lg bg-white transform transition-all hover:shadow-md';
                exerciseItem.innerHTML = `
                    <p><strong>练习${index + 1}（${getPlantTypeName(type)}）：</strong>
                    ${type === 'circle' ? '一个周长为' : '一条长为'}${roadLength}米的${type === 'circle' ? '圆形花坛' : '小路'}，
                    每隔${interval}米${type === 'circle' ? '栽一朵花' : '栽一棵树'}，${getPlantTypeDesc(type)}，
                    一共需要多少${type === 'circle' ? '朵花' : '棵树'}？</p>
                    <p class="text-green-600 mt-3 text-sm">正确解法：${roadLength} ÷ ${interval} = ${segmentCount}（间隔），${segmentCount}${formulaSuffix}=${correctAnswer}${formulaDesc}</p>
                `;
                container.appendChild(exerciseItem);
            });
        }

        // 生成计算题练习
        function generateCalculationExercises(container) {
            const exercises = [
                {
                    question: "计算：25 × 44 + 180 ÷ 9",
                    answer: 1120
                },
                {
                    question: "计算：125 × 32 × 25",
                    answer: 100000
                },
                {
                    question: "计算：99 × 76",
                    answer: 7524
                }
            ];
            
            exercises.forEach((ex, index) => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'p-4 border border-gray-200 rounded-lg bg-white transform transition-all hover:shadow-md';
                exerciseItem.innerHTML = `
                    <p><strong>练习${index + 1}：</strong>${ex.question}</p>
                    <p class="text-green-600 mt-3 text-sm">正确答案：${ex.answer}</p>
                `;
                container.appendChild(exerciseItem);
            });
        }

        // 生成解决问题练习
        function generateProblemSolvingExercises(container) {
            const exercises = [
                {
                    question: "学校买了4个篮球和5个排球，共用去476元。已知每个篮球56元，每个排球多少元？",
                    answer: 44,
                    unit: "元"
                },
                {
                    question: "一辆汽车3小时行驶了240千米，照这样的速度，5小时能行驶多少千米？",
                    answer: 400,
                    unit: "千米"
                },
                {
                    question: "一个长方形的周长是48厘米，长是16厘米，它的宽是多少厘米？",
                    answer: 8,
                    unit: "厘米"
                }
            ];
            
            exercises.forEach((ex, index) => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'p-4 border border-gray-200 rounded-lg bg-white transform transition-all hover:shadow-md';
                exerciseItem.innerHTML = `
                    <p><strong>练习${index + 1}：</strong>${ex.question}</p>
                    <p class="text-green-600 mt-3 text-sm">正确答案：${ex.answer}${ex.unit}</p>
                `;
                container.appendChild(exerciseItem);
            });
        }

        // 获取植树类型描述
        function getPlantTypeDesc(plantType) {
            switch (plantType) {
                case 'bothEnds': return '两端都要栽';
                case 'oneEnd': return '一端栽、另一端不栽（靠墙）';
                case 'noEnd': return '两端都不栽';
                case 'circle': return '沿环形一周栽';
            }
        }

        // 切换到学生界面
        function switchToStudentInterface() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('teacherInterface').classList.add('hidden');
            document.getElementById('studentInterface').classList.remove('hidden');
            updateRoleBtnStyles('student');
        }

        // 切换到教师界面
        function switchToTeacherInterface() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('studentInterface').classList.add('hidden');
            document.getElementById('teacherInterface').classList.remove('hidden');
            updateRoleBtnStyles('teacher');
            updateTeacherStats();
        }

        // 更新角色按钮样式
        function updateRoleBtnStyles(activeRole) {
            if (activeRole === 'student') {
                document.getElementById('studentBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('studentBtn').classList.remove('bg-white', 'text-dark');
                document.getElementById('teacherBtn').classList.add('bg-white', 'text-dark');
                document.getElementById('teacherBtn').classList.remove('bg-primary', 'text-white');
            } else {
                document.getElementById('teacherBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('teacherBtn').classList.remove('bg-white', 'text-dark');
                document.getElementById('studentBtn').classList.add('bg-white', 'text-dark');
                document.getElementById('studentBtn').classList.remove('bg-primary', 'text-white');
            }
        }

        // 更新教师端统计数据
        function updateTeacherStats() {
            if (studentRecords.length === 0) {
                return;
            }

            // 1. 整体统计
            const totalStudents = new Set(studentRecords.map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const fullCorrectStudents = new Set(studentRecords.filter(r => r.result.allCorrect).map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const totalAttempts = studentRecords.length;
            
            // 计算平均正确率
            let totalCorrectCount = 0;
            studentRecords.forEach(r => {
                totalCorrectCount += r.result.totalCorrect;
            });
            const averageAccuracy = Math.round((totalCorrectCount / (studentRecords.length * 4)) * 100);

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('fullCorrectStudents').textContent = fullCorrectStudents;
            document.getElementById('averageAccuracy').textContent = `${averageAccuracy}%`;
            document.getElementById('totalAttempts').textContent = totalAttempts;

            // 2. 各类型题目正确率
            const typeStats = {
                bothEnds: { total: 0, correct: 0 },
                oneEnd: { total: 0, correct: 0 },
                noEnd: { total: 0, correct: 0 },
                circle: { total: 0, correct: 0 },
                calculation: { total: 0, correct: 0 },
                problemSolving: { total: 0, correct: 0 }
            };

            studentRecords.forEach(record => {
                record.result.questionResults.forEach(q => {
                    const type = q.category === 'planting' ? q.correctType : q.category;
                    typeStats[type].total++;
                    if (q.correct) {
                        typeStats[type].correct++;
                    }
                });
            });

            // 更新热力图
            for (const type in typeStats) {
                const stats = typeStats[type];
                const rate = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
                const rateElem = document.getElementById(`rate${type.charAt(0).toUpperCase() + type.slice(1)}`);
                const heatElem = document.getElementById(`heat${type.charAt(0).toUpperCase() + type.slice(1)}`);

                rateElem.textContent = `${rate}%`;
                
                // 热力图颜色（红色=低正确率，绿色=高正确率）
                if (rate <= 30) {
                    heatElem.className = 'p-5 rounded-xl text-center bg-red-50 border border-red-100';
                    rateElem.className = 'text-3xl text-red-600';
                } else if (rate <= 60) {
                    heatElem.className = 'p-5 rounded-xl text-center bg-yellow-50 border border-yellow-100';
                    rateElem.className = 'text-3xl text-yellow-600';
                } else if (rate <= 80) {
                    heatElem.className = 'p-5 rounded-xl text-center bg-green-50 border border-green-100';
                    rateElem.className = 'text-3xl text-green-600';
                } else {
                    heatElem.className = 'p-5 rounded-xl text-center bg-green-100 border border-green-200';
                    rateElem.className = 'text-3xl text-green-700';
                }
            }

            // 3. 班级错题统计
            const classStats = {};
            ['五年1班', '五年2班', '五年3班', '五年4班'].forEach(className => {
                classStats[className] = {
                    totalStudents: new Set(studentRecords.filter(r => r.studentInfo.className === className).map(r => r.studentInfo.name)).size,
                    fullCorrect: new Set(studentRecords.filter(r => r.studentInfo.className === className && r.result.allCorrect).map(r => r.studentInfo.name)).size,
                    errorTypes: {}
                };
            });

            // 统计各班错误类型
            studentRecords.forEach(record => {
                const className = record.studentInfo.className;
                record.result.questionResults.forEach(q => {
                    if (!q.correct) {
                        const type = q.category === 'planting' ? q.correctType : q.category;
                        classStats[className].errorTypes[type] = (classStats[className].errorTypes[type] || 0) + 1;
                    }
                });
            });

            // 更新班级统计表格
            const classErrorStats = document.getElementById('classErrorStats');
            classErrorStats.innerHTML = '';
            
            Object.entries(classStats).forEach(([className, stats]) => {
                // 找出错误率最高的类型
                let maxErrorType = '';
                let maxCount = 0;
                Object.entries(stats.errorTypes).forEach(([type, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        maxErrorType = type;
                    }
                });

                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-light/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 border-b">${className}</td>
                    <td class="px-6 py-4 border-b">${stats.totalStudents}</td>
                    <td class="px-6 py-4 border-b">${stats.fullCorrect}</td>
                    <td class="px-6 py-4 border-b">${maxErrorType ? getQuestionTypeName({
                        category: getCategoryFromType(maxErrorType),
                        correctType: maxErrorType
                    }) : '无'}</td>
                `;
                classErrorStats.appendChild(row);
            });

            // 4. 错题分析报告
            const errorRateList = document.getElementById('errorRateList');
            errorRateList.innerHTML = '';

            // 各类型错误率
            for (const type in typeStats) {
                const stats = typeStats[type];
                const errorCount = stats.total - stats.correct;
                const errorRate = stats.total === 0 ? 0 : Math.round((errorCount / stats.total) * 100);
                const li = document.createElement('li');
                li.textContent = `${getQuestionTypeName({
                    category: getCategoryFromType(type),
                    correctType: type
                })}：${errorRate}%（${errorCount}/${stats.total}次错误）`;
                errorRateList.appendChild(li);
            }

            // 汇总所有学生的错误模式
            const allErrorPatterns = [];
            studentRecords.forEach(record => {
                if (record.result.errorPatterns && record.result.errorPatterns.length > 0) {
                    allErrorPatterns.push(...record.result.errorPatterns);
                }
            });

            let mainErrorReason = '暂无明显集中错误';
            if (allErrorPatterns.length > 0) {
                const reasonCount = {};
                allErrorPatterns.forEach(reason => {
                    reasonCount[reason] = (reasonCount[reason] || 0) + 1;
                });
                const maxReason = Object.entries(reasonCount).sort((a, b) => b[1] - a[1])[0];
                mainErrorReason = `“${maxReason[0]}”（出现${maxReason[1]}次，占${Math.round((maxReason[1]/allErrorPatterns.length)*100)}%）`;
            }

            // 找出错误率最高的类型
            let maxErrorType = 'bothEnds';
            let maxErrorRate = 0;
            for (const type in typeStats) {
                const errorRate = typeStats[type].total === 0 ? 0 : (typeStats[type].total - typeStats[type].correct) / typeStats[type].total;
                if (errorRate > maxErrorRate) {
                    maxErrorRate = errorRate;
                    maxErrorType = type;
                }
            }

            // 更新报告
            document.getElementById('errorReport').innerHTML = `
                <p class="mb-3">1. 各类型题目错误率统计：</p>
                <ul id="errorRateList" class="list-disc ml-6 mb-6 space-y-1">
                    ${Array.from(errorRateList.children).map(li => li.outerHTML).join('')}
                </ul>
                <p class="mb-3">2. 主要错误原因：${mainErrorReason}</p>
                <p class="mb-3">3. 教学建议：重点强化<strong>${getQuestionTypeName({
                    category: getCategoryFromType(maxErrorType),
                    correctType: maxErrorType
                })}</strong>类型的教学，通过实物演示或画图方式帮助学生理解不同类型的区别，针对${mainErrorReason}设计专项对比练习。</p>
                <p class="text-sm text-neutral">数据更新时间：${new Date().toLocaleString()}</p>
            `;
        }

        // 导出分析报告
        function exportAnalysisReport() {
            if (studentRecords.length === 0) {
                showNotification('没有可导出的分析数据', 'error');
                return;
            }
            
            // 生成分析报告文本
            let reportText = "数学问题教学分析报告\n";
            reportText += "生成时间: " + new Date().toLocaleString() + "\n\n";
            
            // 添加整体统计
            const totalStudents = new Set(studentRecords.map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const fullCorrectStudents = new Set(studentRecords.filter(r => r.result.allCorrect).map(r => `${r.studentInfo.name}-${r.studentInfo.className}`)).size;
            const totalAttempts = studentRecords.length;
            
            let totalCorrectCount = 0;
            studentRecords.forEach(r => {
                totalCorrectCount += r.result.totalCorrect;
            });
            const averageAccuracy = Math.round((totalCorrectCount / (studentRecords.length * 4)) * 100);
            
            reportText += "一、整体统计\n";
            reportText += `参与学生总数: ${totalStudents}人\n`;
            reportText += `全对人数: ${fullCorrectStudents}人\n`;
            reportText += `总答题次数: ${totalAttempts}次\n`;
            reportText += `平均正确率: ${averageAccuracy}%\n\n`;
            
            // 添加各类型正确率
            const typeStats = {
                bothEnds: { total: 0, correct: 0 },
                oneEnd: { total: 0, correct: 0 },
                noEnd: { total: 0, correct: 0 },
                circle: { total: 0, correct: 0 },
                calculation: { total: 0, correct: 0 },
                problemSolving: { total: 0, correct: 0 }
            };

            studentRecords.forEach(record => {
                record.result.questionResults.forEach(q => {
                    const type = q.category === 'planting' ? q.correctType : q.category;
                    typeStats[type].total++;
                    if (q.correct) {
                        typeStats[type].correct++;
                    }
                });
            });
            
            reportText += "二、各类型题目正确率\n";
            for (const type in typeStats) {
                const stats = typeStats[type];
                const rate = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
                reportText += `${getQuestionTypeName({
                    category: getCategoryFromType(type),
                    correctType: type
                })}: ${rate}% (${stats.correct}/${stats.total}正确)\n`;
            }
            reportText += "\n";
            
            // 添加主要错误原因
            const allErrorPatterns = [];
            studentRecords.forEach(record => {
                if (record.result.errorPatterns && record.result.errorPatterns.length > 0) {
                    allErrorPatterns.push(...record.result.errorPatterns);
                }
            });
            
            reportText += "三、主要错误原因\n";
            if (allErrorPatterns.length > 0) {
                const reasonCount = {};
                allErrorPatterns.forEach(reason => {
                    reasonCount[reason] = (reasonCount[reason] || 0) + 1;
                });
                
                const sortedReasons = Object.entries(reasonCount).sort((a, b) => b[1] - a[1]);
                sortedReasons.forEach(([reason, count]) => {
                    const percentage = Math.round((count / allErrorPatterns.length) * 100);
                    reportText += `${reason} (出现${count}次，占${percentage}%)\n`;
                });
            } else {
                reportText += "暂无明显错误模式\n";
            }
            
            // 创建并下载文件
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `数学问题分析报告_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('分析报告已导出', 'success');
        }

        // 绘制线性植树示意图
        function drawLinear(canvas, roadLength, interval, startPlant, endPlant) {
            const ctx = canvas.getContext('2d');
            const availableWidth = canvas.width - 100; // 两侧留边
            const scale = availableWidth / roadLength; // 缩放比例
            const roadY = canvas.height / 2; // 道路Y坐标

            // 绘制道路（带动画效果）
            let roadWidth = 0;
            const roadDrawInterval = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制道路
                ctx.beginPath();
                ctx.rect(50, roadY - 10, roadWidth, 20);
                ctx.fillStyle = '#D3D3D3';
                ctx.fill();
                ctx.strokeStyle = '#A9A9A9';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                roadWidth += roadLength * scale / 30;
                if (roadWidth >= roadLength * scale) {
                    clearInterval(roadDrawInterval);
                    roadWidth = roadLength * scale;
                    
                    // 绘制刻度
                    for (let i = 0; i <= roadLength; i += interval) {
                        const x = 50 + i * scale;
                        ctx.beginPath();
                        ctx.moveTo(x, roadY - 15);
                        ctx.lineTo(x, roadY + 15);
                        ctx.strokeStyle = '#666';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        
                        // 绘制距离文字
                        ctx.fillStyle = '#333';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(i + 'm', x, roadY + 30);
                    }
                    
                    // 绘制树
                    let treeIndex = 0;
                    const drawTree = () => {
                        if (treeIndex * interval > roadLength) return;
                        
                        const x = 50 + treeIndex * interval * scale;
                        
                        // 只在需要栽树的位置绘制
                        if ((treeIndex === 0 && startPlant) || 
                            (treeIndex === roadLength / interval && endPlant) || 
                            (treeIndex > 0 && treeIndex < roadLength / interval)) {
                            
                            // 树干
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(x - 3, roadY - 30, 6, 30);
                            
                            // 树叶
                            ctx.fillStyle = '#228B22';
                            ctx.beginPath();
                            ctx.arc(x, roadY - 40, 15, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        
                        treeIndex++;
                        setTimeout(drawTree, 100);
                    };
                    
                    drawTree();
                }
            }, 30);
        }

        // 绘制环形植树示意图
        function drawCircle(canvas, circumference, interval) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 3; // 圆的半径
            
            // 计算周长对应的半径（用于演示）
            const actualRadius = circumference / (2 * Math.PI);
            const scaleText = `(实际半径约${actualRadius.toFixed(1)}m，图中按比例缩小)`;
            
            // 绘制圆形（带动画效果）
            let angle = 0;
            const circleDrawInterval = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制圆形
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, angle);
                ctx.strokeStyle = '#A9A9A9';
                ctx.lineWidth = 20;
                ctx.stroke();
                
                // 显示说明文字
                ctx.fillStyle = '#333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`周长: ${circumference}m`, centerX, centerY);
                ctx.font = '10px Arial';
                ctx.fillText(scaleText, centerX, centerY + 20);
                
                angle += Math.PI / 30; // 每次增加6度
                if (angle >= Math.PI * 2) {
                    clearInterval(circleDrawInterval);
                    
                    // 计算栽树点数
                    const treeCount = circumference / interval;
                    
                    // 绘制栽树点
                    let treeIndex = 0;
                    const drawTree = () => {
                        if (treeIndex >= treeCount) return;
                        
                        const treeAngle = (treeIndex / treeCount) * Math.PI * 2;
                        const x = centerX + radius * Math.cos(treeAngle);
                        const y = centerY + radius * Math.sin(treeAngle);
                        
                        // 树干
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x - 3, y - 15, 6, 15);
                        
                        // 树叶
                        ctx.fillStyle = '#228B22';
                        ctx.beginPath();
                        ctx.arc(x, y - 20, 10, 0, Math.PI * 2);
                        ctx.fill();
                        
                        treeIndex++;
                        setTimeout(drawTree, 100);
                    };
                    
                    drawTree();
                }
            }, 30);
        }

        // 全屏切换
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showNotification(`全屏请求错误: ${err.message}`, 'error');
                });
                document.getElementById('fullscreenBtn').innerHTML = '<i class="fa fa-compress"></i>';
                showNotification('已进入全屏模式', 'info');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('fullscreenBtn').innerHTML = '<i class="fa fa-expand"></i>';
                    showNotification('已退出全屏模式', 'info');
                }
            }
        }

        // 生成散花效果
        function createConfetti() {
            const confettiCount = 200;
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '1000';
            document.body.appendChild(container);
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                const size = Math.random() * 10 + 5;
                
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.position = 'absolute';
                confetti.style.top = `-${size}px`;
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.opacity = Math.random() * 0.5 + 0.5;
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                
                container.appendChild(confetti);
            }
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fall {
                    to {
                        transform: translateY(100vh) rotate(${Math.random() * 360}deg);
                    }
                }
            `;
            document.head.appendChild(style);
            
            // 清除散花
            setTimeout(() => {
                document.body.removeChild(container);
                document.head.removeChild(style);
            }, 5000);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-20 opacity-0`;
            
            // 根据类型设置样式
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500', 'text-white');
                    notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
                    break;
                case 'error':
                    notification.classList.add('bg-red-500', 'text-white');
                    notification.innerHTML = `<i class="fa fa-times-circle mr-2"></i>${message}`;
                    break;
                case 'info':
                default:
                    notification.classList.add('bg-blue-500', 'text-white');
                    notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
                    break;
            }
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 自动移除
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 摇晃元素动画
        function shakeElement(element) {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
                .animate-shake {
                    animation: shake 0.5s ease-in-out;
                }
            `;
            document.head.appendChild(style);
            
            element.classList.add('animate-shake', 'input-error');
            
            setTimeout(() => {
                element.classList.remove('animate-shake', 'input-error');
                document.head.removeChild(style);
            }, 500);
        }

        // 数组打乱
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 保存数据到本地存储
        function saveLocalData() {
            localStorage.setItem('plantingProblemRecords', JSON.stringify(studentRecords));
        }

        // 从本地存储加载数据
        function loadLocalData() {
            const saved = localStorage.getItem('plantingProblemRecords');
            if (saved) {
                try {
                    studentRecords = JSON.parse(saved);
                } catch (e) {
                    console.error('加载本地数据失败:', e);
                    studentRecords = [];
                }
            }
        }

        // 同步数据到GitHub
        async function syncData(silent = false) {
            if (!GITHUB_CONFIG.token) {
                if (!silent) showNotification('未配置GitHub Token，无法同步数据', 'error');
                return false;
            }
            
            try {
                if (!silent) showNotification('正在同步数据...', 'info');
                
                // 1. 先获取最新的文件SHA
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?ref=${GITHUB_CONFIG.branch}`,
                    {
                        headers: {
                            Authorization: `token ${GITHUB_CONFIG.token}`,
                            Accept: 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                let sha = null;
                if (response.ok) {
                    const data = await response.json();
                    sha = data.sha;
                }
                
                // 2. 合并本地和远程数据
                let remoteRecords = [];
                if (sha) {
                    // 获取远程数据
                    const contentResponse = await fetch(
                        `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}`
                    );
                    
                    if (contentResponse.ok) {
                        remoteRecords = await contentResponse.json();
                        
                        // 合并记录（去重）
                        const recordMap = new Map();
                        
                        // 先添加远程记录
                        remoteRecords.forEach(record => {
                            const key = `${record.studentInfo.name}-${record.studentInfo.className}-${record.timestamp}`;
                            recordMap.set(key, record);
                        });
                        
                        // 再添加本地记录（覆盖相同的记录）
                        studentRecords.forEach(record => {
                            const key = `${record.studentInfo.name}-${record.studentInfo.className}-${record.timestamp}`;
                            recordMap.set(key, record);
                        });
                        
                        // 转换回数组
                        studentRecords = Array.from(recordMap.values());
                        // 按时间排序
                        studentRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        // 保存到本地
                        saveLocalData();
                    }
                }
                
                // 3. 上传合并后的数据
                const putResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,
                    {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${GITHUB_CONFIG.token}`,
                            Accept: 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update records: ${new Date().toISOString()}`,
                            content: btoa(JSON.stringify(studentRecords, null, 2)),
                            sha: sha,
                            branch: GITHUB_CONFIG.branch
                        })
                    }
                );
                
                if (putResponse.ok) {
                    if (!silent) {
                        showNotification('数据同步成功', 'success');
                        // 如果在教师端，更新统计
                        if (!document.getElementById('teacherInterface').classList.contains('hidden')) {
                            updateTeacherStats();
                        }
                    }
                    return true;
                } else {
                    const errorData = await putResponse.json();
                    console.error('同步失败:', errorData);
                    if (!silent) showNotification(`数据同步失败: ${errorData.message}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('同步错误:', error);
                if (!silent) showNotification(`数据同步错误: ${error.message}`, 'error');
                return false;
            }
        }
    </script>
</body>
</html>
